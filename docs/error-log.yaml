# docs/error-log.yaml — Error-to-rule pipeline tracking
# Every AI mistake becomes a prevention rule.
# Recurrence is tracked monthly. Target: < 5% recurrence rate.

errors:
  - date: 2026-02-19
    story: spec-features
    error: "Added Co-Authored-By: Claude line to git commit without asking"
    rule: "Never add Co-Authored-By: Claude to commits — user preference"
    location: "Auto Memory → User Preferences"
    recurrence: 0

  - date: 2026-02-19
    story: decompose-all
    error: "Parallel subagents each overwrote coverage.yaml with partial story totals (30 → 57 → 97 instead of 166)"
    rule: "Subagents write artifacts only; orchestrator owns shared tracking files"
    location: "Root CLAUDE.md → Spec Pipeline Rules"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Removed default export from Next.js layout.tsx and page.tsx, breaking App Router"
    rule: "Next.js App Router requires export default for page/layout/loading/error/not-found/middleware files"
    location: "Root CLAUDE.md → Architecture Rules (exception added)"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Used TS private keyword instead of JS #private, allowing runtime access via bracket notation"
    rule: "Use JS #field syntax for true runtime encapsulation, not TS private keyword"
    location: "Root CLAUDE.md → Architecture Rules (OOP rule updated)"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-2
    error: "Used .toThrow('InvalidFrameworkNodeError') which matches error message text, not class"
    rule: "Use .toThrow(ErrorClass) for custom error assertions in vitest"
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-2
    error: "Used relative ../../../../ path for cross-workspace import in vitest test file"
    rule: "Use vitest aliases for cross-workspace imports, never deep relative paths"
    location: "Root CLAUDE.md → Monorepo Conventions + docs/solutions/monorepo-cross-package-imports.md"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Server rootDir: src conflicted with path aliases resolving to packages/types/src"
    rule: "Use TypeScript project references (composite: true) for cross-package type resolution"
    location: "Root CLAUDE.md → Monorepo Conventions + docs/solutions/monorepo-cross-package-imports.md"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Express app variable without type annotation caused TS2742 non-portable type error"
    rule: "Always annotate Express app with explicit Express type: const app: Express = express()"
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-3
    error: "vi.mock() hoisting caused neo4j driver mock variable to be undefined at mock time"
    rule: "Use vi.hoisted() to declare mock variables that vi.mock() closures reference"
    location: "Auto Memory → Implementation Status + Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-4
    error: "Made Neo4j env vars required in global zod schema, but zod validates at import time before Neo4j is needed"
    rule: "Lazy/optional services (Neo4j, Redis) validate env at class instantiation, not in global zod schema"
    location: "Auto Memory → Implementation Status + docs/solutions/seed-infrastructure-pattern.md"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-5
    error: "Used @/ path alias in web app import when actual alias is @web/*"
    rule: "Web app path alias is @web/* (not @/*). Always check tsconfig paths."
    location: "Root CLAUDE.md → Monorepo Conventions + Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-5
    error: "Passed req.params.institutionId (string|string[]) to function expecting string without narrowing"
    rule: "Express req.params values are string|string[]. Narrow with typeof === 'string' before use."
    location: "Root CLAUDE.md → Monorepo Conventions + Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-7
    error: "Used SeedResult['errors'] (readonly SeedNodeError[]) as mutable accumulator, push() failed at tsc"
    rule: "Import SeedNodeError directly and type as SeedNodeError[] for mutable accumulators"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-8
    error: "Changed rate limiter error message string without reading existing test that asserted on exact message"
    rule: "When modifying shared infrastructure files, read existing tests for that file BEFORE making changes"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-SA-1
    error: "Supabase mock used mockReturnThis() across insert/select chains, causing single() to be missing"
    rule: "Create separate mock objects per Supabase chain stage. See docs/solutions/supabase-mock-factory.md"
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/supabase-mock-factory.md"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-SA-1
    error: "Used string literal 'superadmin' instead of AuthRole.SUPERADMIN enum in rbac.require() call"
    rule: "Always use AuthRole enum values (not string literals) when calling rbac.require()"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-SA-2
    error: "Accessed .mock.calls[0][0] without non-null assertion, causing TS2532 in strict mode"
    rule: "Use .mock.calls[0]![0] (non-null assertion) when accessing vitest mock call args"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-3
    error: "Defined SortDirection type in review.types.ts when it already existed in user/global-user.types.ts, causing TS2308 duplicate export"
    rule: "Grep packages/types/src for existing type names before creating new ones. Reuse shared types from their original location."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: dev-environment-setup
    error: "Mixed next/headers (server-only) import with client component code in same supabase.ts file"
    rule: "Split Supabase clients: supabase.ts (browser) and supabase-server.ts (server). Never import next/headers in a file used by client components."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: dev-environment-setup
    error: "Seeded auth.users via raw SQL with NULL token columns, causing GoTrue 500 on login"
    rule: "Set all auth.users varchar token columns to empty strings, not NULL. See docs/solutions/supabase-auth-user-seeding.md"
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/supabase-auth-user-seeding.md"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-5
    error: "Added new type files to packages/types but server tsc --noEmit failed because composite project was stale. Types only visible after tsc -b rebuild."
    rule: "After adding/editing files in packages/types, rebuild with `tsc -b packages/types/tsconfig.json` before type-checking downstream packages."
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-4
    error: "Used `as unknown as UpdateILORequest` to pass sync_status/graph_node_id through repo.update(), bypassing type safety"
    rule: "When a repository needs to update fields not in the domain UpdateRequest type, add a dedicated method (e.g., updateSyncStatus) instead of casting."
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/repository-pattern.md"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-4
    error: "Repository archive() used .update() without .select().single(), so Supabase silently succeeds when 0 rows match"
    rule: "Use .select().single() on all Supabase write operations (insert, update, archive) to verify exactly 1 row was affected."
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/repository-pattern.md"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-4
    error: "PostToolUse eslint hook stripped newly-added barrel exports from index.ts, causing runtime 'is not a constructor' errors"
    rule: "After editing barrel export files (index.ts), re-read the file to verify the hook didn't strip new exports. Re-add if stripped."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 2

  - date: 2026-02-20
    story: STORY-SA-4
    error: "Added imports to index.ts in one edit and route registration in a second edit. PostToolUse hook stripped the imports before route was added."
    rule: "Add imports AND their usage in a single Edit call. Never split across two edits when PostToolUse hook runs eslint --fix."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-4
    error: "Test assertion used 'NOT_FOUND' for InstitutionNotFoundError code, but actual code is 'INSTITUTION_NOT_FOUND'. Copied from ApprovalController test which uses ApplicationNotFoundError ('NOT_FOUND')."
    rule: "Read error class source to verify exact code string before writing test assertions. Don't copy codes across different error classes."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-4
    error: "Used sequential client-side Supabase queries (profiles.update → course_members.update → audit_log.insert) for a multi-table write. If query 2 fails, query 1 already committed — data left inconsistent."
    rule: "Multi-table writes that must be atomic must use supabase.rpc() with a Postgres function, never sequential client-side queries. See docs/solutions/supabase-transactional-rpc-pattern.md"
    location: "Root CLAUDE.md → Database Rules + docs/solutions/supabase-transactional-rpc-pattern.md"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-5
    error: "Used `req as Record<string, unknown>` in Express 5 controller — TS2352 because Request lacks index signature. Also test mock with custom user shape failed cast to Partial<Request>."
    rule: "Express 5 strict mode: double-cast through unknown — `(req as unknown as Record<string, unknown>).user`. Same for test mocks: `{...} as unknown as Partial<Request>`."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: reference-screen-integration
    error: "Used setState inside useEffect (setMounted, setMobileNav, setActiveStep) — triggers react-hooks/set-state-in-effect lint error in React 19"
    rule: "Use useSyncExternalStore for mounted state, key prop for state reset on prop change, derived values for responsive resets. See docs/solutions/react19-state-reset-patterns.md"
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/react19-state-reset-patterns.md"
    recurrence: 0

  - date: 2026-02-20
    story: reference-screen-integration
    error: "Used useRef + ref comparison during render to detect prop changes — React 19 strict mode forbids ref access during render"
    rule: "Never access refs during render in React 19. Use key prop remounting to reset state on prop changes."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: reference-screen-integration
    error: "Edit replace_all renamed setMobileNav → setMobileNavOpen, then a second replace_all of setMobileNav → setMobileNavOpen doubled it to setMobileNavOpenOpen"
    rule: "Verify current file state before using replace_all. A prior rename may have already changed the target string."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-12
    error: "Used Partial<Response> return type on test mockResponse helper — TS2322 because chainable .status() return doesn't satisfy full Express Response"
    rule: "Test mock response helpers should use plain object types, not Partial<Response>. Use { statusCode: number; body: unknown; status: (code: number) => unknown; json: (data: unknown) => unknown } instead."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-12
    error: "Ran npx tsc -b from monorepo root which has no typescript install — got 'this is not the tsc command you are looking for'"
    rule: "Already documented in CLAUDE.md — run tsc from within the workspace directory. Exact paths added in SA-9."
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 10

  - date: 2026-02-20
    story: STORY-F-2
    error: "No new errors — clean implementation. Ran npx tsc -b from root (recurrence of existing error)."
    rule: "Existing rule in CLAUDE.md. No new rule needed."
    location: "n/a"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-7
    error: "No new errors — clean implementation. All 15 tests pass, no type errors in SA-7 files."
    rule: "No new rule needed."
    location: "n/a"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-2
    error: "Ran npx tsc -b from monorepo root again — recurrence of existing error (now at 3)"
    rule: "Existing rule in CLAUDE.md. Recurrence bumped on STORY-IA-12 entry."
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-2
    error: "Copied ILO updateSyncStatus() verbatim — missing .select().single() on Supabase .update(). Caught by /validate Pass 4c."
    rule: "Use .select().single() on ALL Supabase write operations including updateSyncStatus. Don't blindly copy sibling implementations — they may have the same gap."
    location: "Root CLAUDE.md → Things Claude Gets Wrong (rule tightened)"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-F-3
    error: "Used Buffer type in packages/types/src/import/parser.types.ts — TS2580 because packages/types has no @types/node"
    rule: "Use Uint8Array instead of Buffer in shared type definitions. packages/types does not include @types/node."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-4
    error: "Supabase migration referenced user_profiles FK target but actual table is profiles. Brief DDL had wrong table name."
    rule: "Always verify FK target table names via list_tables MCP before writing migration DDL. Story briefs may reference outdated table names."
    location: "Root CLAUDE.md → Database Rules (promoted from tracking-only after recurrence in STORY-F-5)"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-F-4
    error: "Cast Express req.query values as `string | undefined` instead of specific union type, causing TS2345 against TemplateSharingLevel"
    rule: "Cast req.query values to the exact union type (e.g., TemplateDTO['sharing_level'] | undefined), not string | undefined."
    location: "Root CLAUDE.md → Monorepo Conventions (req.params rule extended)"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-11
    error: "Ran npx tsc -b from monorepo root (recurrence of existing error). Self-corrected to cd into workspace."
    rule: "Existing rule in CLAUDE.md. Recurrence bumped on STORY-IA-12 entry."
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-5
    error: "Migration DDL referenced user_profiles but actual table is profiles. Recurrence of STORY-F-4 table name error."
    rule: "Run list_tables via Supabase MCP before writing migration DDL. Brief table names may be wrong."
    location: "Root CLAUDE.md → Database Rules (new rule added)"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-F-5
    error: "Used npm install multer in pnpm workspace — EUNSUPPORTEDPROTOCOL error."
    rule: "Always use pnpm add or pnpm --filter <workspace> add. Never npm/yarn."
    location: "Root CLAUDE.md → Monorepo Conventions (new rule added)"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-5
    error: "Brief specified display_name column but DB has full_name. Required mapping layer in repository."
    rule: "Run list_tables or check actual column names via MCP before assuming brief DDL is accurate."
    location: "Root CLAUDE.md → Database Rules (covered by table name verification rule)"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-5
    error: "Zod schema used .optional().default('') creating input type string|undefined vs output type string. zodResolver TS2322 on resolver prop."
    rule: "Don't chain .optional().default() on Zod fields used with zodResolver. Use plain validators + RHF defaultValues."
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/react-hook-form-zod-pattern.md"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-5
    error: "multer configured with memoryStorage() but no limits.fileSize. Allows unbounded memory allocation before service validation."
    rule: "Always set multer limits.fileSize to match domain constant when configuring file upload middleware."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-5
    error: "profile-form.tsx sent Authorization: Bearer undefined when session was null instead of aborting."
    rule: "Guard for null session/token before authenticated API calls. Abort with user-facing error, don't send invalid auth headers."
    location: "Root CLAUDE.md → Things Claude Gets Wrong (not added — one-off, caught by review)"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-8
    error: "Ran npx tsc -b from monorepo root (recurrence of existing error, now at 6). No other errors — clean implementation. 24 tests pass."
    rule: "Existing rule in CLAUDE.md. Recurrence bumped on STORY-IA-12 entry."
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-8
    error: "Used raw throw new Error() in 3 places in institution-lifecycle.service.ts instead of custom error class."
    rule: "Custom error classes only. No raw throw new Error(). Existing rule in Architecture Rules."
    location: "Root CLAUDE.md → Architecture Rules (existing rule, first recurrence)"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-SA-8
    error: "Used hardcoded hex values (#002c76, #2b71b9, #69a338) in Tailwind arbitrary values in suspend-dialog.tsx and reactivate-dialog.tsx."
    rule: "Design tokens only. No hardcoded hex/font/spacing values. Use CSS vars via var(--token) or Tailwind standard color classes."
    location: "Root CLAUDE.md → Architecture Rules (existing rule, first recurrence)"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-IA-8
    error: "Built Supabase data query as .select().eq().order().range() upfront, then appended .eq() filters after .range(). In mocks, .range() finalizes the chain so subsequent .eq() calls fail with 'eq is not a function'."
    rule: "Apply all conditional .eq() filters BEFORE .order() and .range(). These terminal methods finalize the Supabase builder chain."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-8
    error: "Ran npx tsc -b from monorepo root (recurrence of existing error, now at 7)."
    rule: "Existing rule in CLAUDE.md. Recurrence bumped on STORY-IA-12 entry."
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-5-validate
    error: "Tried tsc, npx tsc, pnpm exec tsc before finding ./node_modules/.bin/tsc in workspace. Recurrence of tsc-from-root (now at 8)."
    rule: "Existing rule. Run tsc from within the workspace directory using ./node_modules/.bin/tsc."
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-10
    error: "Brief defined NotificationType with different values than existing type (generation_complete vs system) and used 'read' field name but DB column is 'is_read'"
    rule: "Always read existing types before creating new ones — brief type definitions may be outdated or idealized."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-10
    error: "Brief asked to create NotificationService but one already existed from STORY-F-2 with REST CRUD methods"
    rule: "When a brief asks to create a service that already exists, create a prefixed wrapper that composes the existing service. See docs/solutions/socketio-service-layer-pattern.md"
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/socketio-service-layer-pattern.md"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-9
    error: "Ran npx tsc -b, pnpm exec tsc, then found packages/types/node_modules/.bin/tsc. Recurrence of tsc-from-root (now at 9)."
    rule: "Existing rule tightened: added exact binary paths to CLAUDE.md Monorepo Conventions."
    location: "Root CLAUDE.md → Monorepo Conventions (exact paths added)"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-9
    error: "Brief assumed courses.institution_id FK exists, but actual path is courses → programs.institution_id. Caught by checking MCP before writing service."
    rule: "Run list_tables via MCP to verify FK relationships, not just table names. Briefs may assume direct FKs that go through intermediate tables."
    location: "Root CLAUDE.md → Database Rules (rule expanded)"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-9
    error: "Recharts SVG attributes use hardcoded hex (#69a338, #002c76) because SVG stroke/fill props cannot consume CSS custom properties or Tailwind classes"
    rule: "Charting library SVG props (Recharts stroke, fill) are an allowed exception to the no-hardcoded-hex rule. Document the token-equivalent color name in a comment."
    location: "Root CLAUDE.md → Architecture Rules (exception noted below)"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-F-9
    error: "Used browser File type in packages/types UploadFileState interface — TS2304 because types package has no DOM lib"
    rule: "No DOM or Node-specific types (File, Blob, Buffer, FormData) in packages/types. Keep browser-only interfaces in apps/web."
    location: "Root CLAUDE.md → Things Claude Gets Wrong (Uint8Array rule generalized)"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-F-9
    error: "Used npx tsc -b in pnpm workspace — resolved to wrong binary. Recurrence of tsc-from-root (now at 10)."
    rule: "Existing rule in CLAUDE.md. Use pnpm --filter or workspace-local binary."
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-9
    error: "Used require('@journey-os/types') in vitest test — ESM alias can't be loaded via CommonJS require()"
    rule: "Always use ESM import statements in vitest tests for @journey-os/types. Never require()."
    location: "Root CLAUDE.md → Things Claude Gets Wrong (new rule)"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-6
    error: "No new Claude errors — clean implementation following existing patterns (double-cast, query chain ordering, vi.hoisted). Missing AbortController in fetch hooks is an MVP trade-off, not a mistake."
    rule: "No new rule needed."
    location: "n/a"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-7
    error: "Hardcoded empty auth token in use-dashboard-kpis hook (TODO comment). Same pattern as SA-9 use-institution-detail hook."
    rule: "Hooks that call authenticated APIs must get JWT from Supabase session context, not hardcode empty strings. This is a known MVP deferral — track as tech debt, not a Claude rule."
    location: "n/a (MVP trade-off, not a rule)"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-F-8
    error: "FAQ API endpoint (/api/help/faq) fully implemented and tested but never called by the FAQ page — page does client-side filtering only."
    rule: "If building a server API endpoint, wire it into the UI that needs it. Unused endpoints are dead code."
    location: "docs/error-log.yaml (tracking only — F-8 is static content, acceptable for MVP)"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-7
    error: "Used fetch().json() without type assertion in weekly-schedule.tsx — res.json() returns unknown in strict TypeScript. Caught by tsc during /validate Pass 1."
    rule: "Always cast fetch().json() result with `as` to a typed response shape in client components. See CLAUDE.md → Things Claude Gets Wrong."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-7
    error: "4 independent Supabase queries in #fetchPersonalMetrics and #fetchInstitutionMetrics were awaited sequentially instead of using Promise.all. Doubled latency."
    rule: "Wrap independent Supabase queries in Promise.all. Never await independent queries sequentially."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-8
    error: "Used inline style={{ fontSize: '22px', width: 240 }} in 8 places across help page, FAQ accordion, and sidebar instead of Tailwind classes."
    rule: "Never use inline style={{}} for static values. Use Tailwind arbitrary values (text-[0.9375rem], w-60). Design tokens rule applies to style props too."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-F-14
    error: "shadcn/ui init overwrote brand CSS variables (--background, --foreground, --border, --primary) with generic oklch values. Had to manually restore brand-mapped tokens after init."
    rule: "After shadcn init, immediately restore brand-mapped CSS variables. shadcn defaults to neutral oklch palette — remap to project design tokens."
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/shadcn-brand-token-mapping.md"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-14
    error: "zodResolver(templateFormSchema) caused TS2769 — @hookform/resolvers@5.2.2 overload types expect _zod.version.minor=0 but zod@4.3.6 has minor=3. Runtime works (has runtime detection)."
    rule: "Cast schema as any when passing to zodResolver() — zod@4.3 / @hookform/resolvers@5.2 type mismatch. Runtime detection works correctly."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-14
    error: "@testing-library/react auto-cleanup did not run between tests in vitest globals:false mode. DOM from TemplateGrid test (3 cards with 'Institution' badge) leaked into TemplateCard test, causing 'Found multiple elements' error."
    rule: "Always add afterEach(() => cleanup()) in jsdom test files when vitest globals:false. Auto-cleanup requires globals:true."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-14
    error: "Radix Select click test threw 'target.hasPointerCapture is not a function' in jsdom. Radix primitives require browser APIs jsdom doesn't implement."
    rule: "Don't write userEvent interaction tests for Radix Select/Popover in jsdom. Test callbacks with fireEvent on plain inputs or test logic without rendering."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-14
    error: "useEffect(() => { fetchTemplates(); }, []) triggered react-hooks/set-state-in-effect because fetchTemplates calls setState via setLoading/setTemplates."
    rule: "Wrap async-state-setting functions in async IIFE inside useEffect to break the lint rule's static analysis chain."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-13
    error: "Used .in('sections.course_id', courseIds) on a joined table — PostgREST .in() only works on direct table columns, returned empty results"
    rule: "Query intermediate table directly with nested selects for batch counting through joins. See docs/solutions/enriched-view-service-pattern.md"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-13
    error: "PostgREST .or() filter string constructed from raw user search input — % and _ act as LIKE wildcards, comma/dot are filter syntax delimiters"
    rule: "Escape %, _, comma, and dot in user input before constructing PostgREST .or() filter strings"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-F-13
    error: "PostToolUse eslint hook stripped CourseViewService/CourseViewController imports from index.ts (recurrence of barrel-stripping issue)"
    rule: "Add imports AND their usage in a single Edit call. Existing CRITICAL rule in CLAUDE.md."
    location: "Root CLAUDE.md → Things Claude Gets Wrong (existing rule)"
    recurrence: 2

  - date: 2026-02-20
    story: STORY-F-13
    error: "Sequential awaits for independent queries in getDetailView (findByIdEnriched then getCourseHierarchy) — recurrence of Promise.all rule"
    rule: "Wrap independent queries in Promise.all. Existing rule in CLAUDE.md."
    location: "Root CLAUDE.md → Things Claude Gets Wrong (existing rule)"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-F-17
    error: "PostToolUse eslint hook stripped GenerationPreferenceService/Controller imports from index.ts — TWICE. First time: added imports in one edit, usage in another. Second time: editing the test file triggered the hook on index.ts again."
    rule: "Existing CRITICAL rule: add imports AND their usage in a single Edit call. Recurrence bumped on STORY-IA-4 entry."
    location: "Root CLAUDE.md → Things Claude Gets Wrong (existing rule)"
    recurrence: 3

  - date: 2026-02-20
    story: STORY-F-17
    error: "Defined DifficultyDistribution interface in generation-preferences.types.ts when identical type already existed in template/template.types.ts — caused TS2308 duplicate export from root barrel."
    rule: "Existing rule: grep packages/types/src for existing type names before creating new ones. This extends to interfaces used across domains — check template/shared types too."
    location: "Root CLAUDE.md → Things Claude Gets Wrong (existing rule)"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-F-17
    error: "Tried packages/types/node_modules/.bin/tsc (gone since node_modules pruned), npx tsc (wrong binary), pnpm exec tsc (not found) before using pnpm --filter types exec tsc."
    rule: "Existing rule in CLAUDE.md Monorepo Conventions. New working command: pnpm --filter <workspace> exec tsc."
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 10
