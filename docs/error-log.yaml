# docs/error-log.yaml — Error-to-rule pipeline tracking
# Every AI mistake becomes a prevention rule.
# Recurrence is tracked monthly. Target: < 5% recurrence rate.

errors:
  - date: 2026-02-19
    story: spec-features
    error: "Added Co-Authored-By: Claude line to git commit without asking"
    rule: "Never add Co-Authored-By: Claude to commits — user preference"
    location: "Auto Memory → User Preferences"
    recurrence: 0

  - date: 2026-02-19
    story: decompose-all
    error: "Parallel subagents each overwrote coverage.yaml with partial story totals (30 → 57 → 97 instead of 166)"
    rule: "Subagents write artifacts only; orchestrator owns shared tracking files"
    location: "Root CLAUDE.md → Spec Pipeline Rules"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Removed default export from Next.js layout.tsx and page.tsx, breaking App Router"
    rule: "Next.js App Router requires export default for page/layout/loading/error/not-found/middleware files"
    location: "Root CLAUDE.md → Architecture Rules (exception added)"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Used TS private keyword instead of JS #private, allowing runtime access via bracket notation"
    rule: "Use JS #field syntax for true runtime encapsulation, not TS private keyword"
    location: "Root CLAUDE.md → Architecture Rules (OOP rule updated)"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-2
    error: "Used .toThrow('InvalidFrameworkNodeError') which matches error message text, not class"
    rule: "Use .toThrow(ErrorClass) for custom error assertions in vitest"
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-2
    error: "Used relative ../../../../ path for cross-workspace import in vitest test file"
    rule: "Use vitest aliases for cross-workspace imports, never deep relative paths"
    location: "Root CLAUDE.md → Monorepo Conventions + docs/solutions/monorepo-cross-package-imports.md"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Server rootDir: src conflicted with path aliases resolving to packages/types/src"
    rule: "Use TypeScript project references (composite: true) for cross-package type resolution"
    location: "Root CLAUDE.md → Monorepo Conventions + docs/solutions/monorepo-cross-package-imports.md"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Express app variable without type annotation caused TS2742 non-portable type error"
    rule: "Always annotate Express app with explicit Express type: const app: Express = express()"
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-3
    error: "vi.mock() hoisting caused neo4j driver mock variable to be undefined at mock time"
    rule: "Use vi.hoisted() to declare mock variables that vi.mock() closures reference"
    location: "Auto Memory → Implementation Status + Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-4
    error: "Made Neo4j env vars required in global zod schema, but zod validates at import time before Neo4j is needed"
    rule: "Lazy/optional services (Neo4j, Redis) validate env at class instantiation, not in global zod schema"
    location: "Auto Memory → Implementation Status + docs/solutions/seed-infrastructure-pattern.md"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-5
    error: "Used @/ path alias in web app import when actual alias is @web/*"
    rule: "Web app path alias is @web/* (not @/*). Always check tsconfig paths."
    location: "Root CLAUDE.md → Monorepo Conventions + Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-5
    error: "Passed req.params.institutionId (string|string[]) to function expecting string without narrowing"
    rule: "Express req.params values are string|string[]. Narrow with typeof === 'string' before use."
    location: "Root CLAUDE.md → Monorepo Conventions + Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-7
    error: "Used SeedResult['errors'] (readonly SeedNodeError[]) as mutable accumulator, push() failed at tsc"
    rule: "Import SeedNodeError directly and type as SeedNodeError[] for mutable accumulators"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-8
    error: "Changed rate limiter error message string without reading existing test that asserted on exact message"
    rule: "When modifying shared infrastructure files, read existing tests for that file BEFORE making changes"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0
