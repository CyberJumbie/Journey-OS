# docs/error-log.yaml — Error-to-rule pipeline tracking
# Every AI mistake becomes a prevention rule.
# Recurrence is tracked monthly. Target: < 5% recurrence rate.

errors:
  - date: 2026-02-19
    story: spec-features
    error: "Added Co-Authored-By: Claude line to git commit without asking"
    rule: "Never add Co-Authored-By: Claude to commits — user preference"
    location: "Auto Memory → User Preferences"
    recurrence: 0

  - date: 2026-02-19
    story: decompose-all
    error: "Parallel subagents each overwrote coverage.yaml with partial story totals (30 → 57 → 97 instead of 166)"
    rule: "Subagents write artifacts only; orchestrator owns shared tracking files"
    location: "Root CLAUDE.md → Spec Pipeline Rules"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Removed default export from Next.js layout.tsx and page.tsx, breaking App Router"
    rule: "Next.js App Router requires export default for page/layout/loading/error/not-found/middleware files"
    location: "Root CLAUDE.md → Architecture Rules (exception added)"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Used TS private keyword instead of JS #private, allowing runtime access via bracket notation"
    rule: "Use JS #field syntax for true runtime encapsulation, not TS private keyword"
    location: "Root CLAUDE.md → Architecture Rules (OOP rule updated)"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-2
    error: "Used .toThrow('InvalidFrameworkNodeError') which matches error message text, not class"
    rule: "Use .toThrow(ErrorClass) for custom error assertions in vitest"
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-2
    error: "Used relative ../../../../ path for cross-workspace import in vitest test file"
    rule: "Use vitest aliases for cross-workspace imports, never deep relative paths"
    location: "Root CLAUDE.md → Monorepo Conventions + docs/solutions/monorepo-cross-package-imports.md"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Server rootDir: src conflicted with path aliases resolving to packages/types/src"
    rule: "Use TypeScript project references (composite: true) for cross-package type resolution"
    location: "Root CLAUDE.md → Monorepo Conventions + docs/solutions/monorepo-cross-package-imports.md"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-1
    error: "Express app variable without type annotation caused TS2742 non-portable type error"
    rule: "Always annotate Express app with explicit Express type: const app: Express = express()"
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-3
    error: "vi.mock() hoisting caused neo4j driver mock variable to be undefined at mock time"
    rule: "Use vi.hoisted() to declare mock variables that vi.mock() closures reference"
    location: "Auto Memory → Implementation Status + Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-4
    error: "Made Neo4j env vars required in global zod schema, but zod validates at import time before Neo4j is needed"
    rule: "Lazy/optional services (Neo4j, Redis) validate env at class instantiation, not in global zod schema"
    location: "Auto Memory → Implementation Status + docs/solutions/seed-infrastructure-pattern.md"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-5
    error: "Used @/ path alias in web app import when actual alias is @web/*"
    rule: "Web app path alias is @web/* (not @/*). Always check tsconfig paths."
    location: "Root CLAUDE.md → Monorepo Conventions + Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-5
    error: "Passed req.params.institutionId (string|string[]) to function expecting string without narrowing"
    rule: "Express req.params values are string|string[]. Narrow with typeof === 'string' before use."
    location: "Root CLAUDE.md → Monorepo Conventions + Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-7
    error: "Used SeedResult['errors'] (readonly SeedNodeError[]) as mutable accumulator, push() failed at tsc"
    rule: "Import SeedNodeError directly and type as SeedNodeError[] for mutable accumulators"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-U-8
    error: "Changed rate limiter error message string without reading existing test that asserted on exact message"
    rule: "When modifying shared infrastructure files, read existing tests for that file BEFORE making changes"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-SA-1
    error: "Supabase mock used mockReturnThis() across insert/select chains, causing single() to be missing"
    rule: "Create separate mock objects per Supabase chain stage. See docs/solutions/supabase-mock-factory.md"
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/supabase-mock-factory.md"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-SA-1
    error: "Used string literal 'superadmin' instead of AuthRole.SUPERADMIN enum in rbac.require() call"
    rule: "Always use AuthRole enum values (not string literals) when calling rbac.require()"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-19
    story: STORY-SA-2
    error: "Accessed .mock.calls[0][0] without non-null assertion, causing TS2532 in strict mode"
    rule: "Use .mock.calls[0]![0] (non-null assertion) when accessing vitest mock call args"
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-3
    error: "Defined SortDirection type in review.types.ts when it already existed in user/global-user.types.ts, causing TS2308 duplicate export"
    rule: "Grep packages/types/src for existing type names before creating new ones. Reuse shared types from their original location."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: dev-environment-setup
    error: "Mixed next/headers (server-only) import with client component code in same supabase.ts file"
    rule: "Split Supabase clients: supabase.ts (browser) and supabase-server.ts (server). Never import next/headers in a file used by client components."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: dev-environment-setup
    error: "Seeded auth.users via raw SQL with NULL token columns, causing GoTrue 500 on login"
    rule: "Set all auth.users varchar token columns to empty strings, not NULL. See docs/solutions/supabase-auth-user-seeding.md"
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/supabase-auth-user-seeding.md"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-5
    error: "Added new type files to packages/types but server tsc --noEmit failed because composite project was stale. Types only visible after tsc -b rebuild."
    rule: "After adding/editing files in packages/types, rebuild with `tsc -b packages/types/tsconfig.json` before type-checking downstream packages."
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-4
    error: "Used `as unknown as UpdateILORequest` to pass sync_status/graph_node_id through repo.update(), bypassing type safety"
    rule: "When a repository needs to update fields not in the domain UpdateRequest type, add a dedicated method (e.g., updateSyncStatus) instead of casting."
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/repository-pattern.md"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-4
    error: "Repository archive() used .update() without .select().single(), so Supabase silently succeeds when 0 rows match"
    rule: "Use .select().single() on all Supabase write operations (insert, update, archive) to verify exactly 1 row was affected."
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/repository-pattern.md"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-4
    error: "PostToolUse eslint hook stripped newly-added barrel exports from index.ts, causing runtime 'is not a constructor' errors"
    rule: "After editing barrel export files (index.ts), re-read the file to verify the hook didn't strip new exports. Re-add if stripped."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-SA-4
    error: "Added imports to index.ts in one edit and route registration in a second edit. PostToolUse hook stripped the imports before route was added."
    rule: "Add imports AND their usage in a single Edit call. Never split across two edits when PostToolUse hook runs eslint --fix."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-4
    error: "Test assertion used 'NOT_FOUND' for InstitutionNotFoundError code, but actual code is 'INSTITUTION_NOT_FOUND'. Copied from ApprovalController test which uses ApplicationNotFoundError ('NOT_FOUND')."
    rule: "Read error class source to verify exact code string before writing test assertions. Don't copy codes across different error classes."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-4
    error: "Used sequential client-side Supabase queries (profiles.update → course_members.update → audit_log.insert) for a multi-table write. If query 2 fails, query 1 already committed — data left inconsistent."
    rule: "Multi-table writes that must be atomic must use supabase.rpc() with a Postgres function, never sequential client-side queries. See docs/solutions/supabase-transactional-rpc-pattern.md"
    location: "Root CLAUDE.md → Database Rules + docs/solutions/supabase-transactional-rpc-pattern.md"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-5
    error: "Used `req as Record<string, unknown>` in Express 5 controller — TS2352 because Request lacks index signature. Also test mock with custom user shape failed cast to Partial<Request>."
    rule: "Express 5 strict mode: double-cast through unknown — `(req as unknown as Record<string, unknown>).user`. Same for test mocks: `{...} as unknown as Partial<Request>`."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: reference-screen-integration
    error: "Used setState inside useEffect (setMounted, setMobileNav, setActiveStep) — triggers react-hooks/set-state-in-effect lint error in React 19"
    rule: "Use useSyncExternalStore for mounted state, key prop for state reset on prop change, derived values for responsive resets. See docs/solutions/react19-state-reset-patterns.md"
    location: "Root CLAUDE.md → Things Claude Gets Wrong + docs/solutions/react19-state-reset-patterns.md"
    recurrence: 0

  - date: 2026-02-20
    story: reference-screen-integration
    error: "Used useRef + ref comparison during render to detect prop changes — React 19 strict mode forbids ref access during render"
    rule: "Never access refs during render in React 19. Use key prop remounting to reset state on prop changes."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: reference-screen-integration
    error: "Edit replace_all renamed setMobileNav → setMobileNavOpen, then a second replace_all of setMobileNav → setMobileNavOpen doubled it to setMobileNavOpenOpen"
    rule: "Verify current file state before using replace_all. A prior rename may have already changed the target string."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-12
    error: "Used Partial<Response> return type on test mockResponse helper — TS2322 because chainable .status() return doesn't satisfy full Express Response"
    rule: "Test mock response helpers should use plain object types, not Partial<Response>. Use { statusCode: number; body: unknown; status: (code: number) => unknown; json: (data: unknown) => unknown } instead."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-12
    error: "Ran npx tsc -b from monorepo root which has no typescript install — got 'this is not the tsc command you are looking for'"
    rule: "Already documented in CLAUDE.md — run tsc from within the workspace directory"
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 3

  - date: 2026-02-20
    story: STORY-F-2
    error: "No new errors — clean implementation. Ran npx tsc -b from root (recurrence of existing error)."
    rule: "Existing rule in CLAUDE.md. No new rule needed."
    location: "n/a"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-SA-7
    error: "No new errors — clean implementation. All 15 tests pass, no type errors in SA-7 files."
    rule: "No new rule needed."
    location: "n/a"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-2
    error: "Ran npx tsc -b from monorepo root again — recurrence of existing error (now at 3)"
    rule: "Existing rule in CLAUDE.md. Recurrence bumped on STORY-IA-12 entry."
    location: "Root CLAUDE.md → Monorepo Conventions"
    recurrence: 0

  - date: 2026-02-20
    story: STORY-IA-2
    error: "Copied ILO updateSyncStatus() verbatim — missing .select().single() on Supabase .update(). Caught by /validate Pass 4c."
    rule: "Use .select().single() on ALL Supabase write operations including updateSyncStatus. Don't blindly copy sibling implementations — they may have the same gap."
    location: "Root CLAUDE.md → Things Claude Gets Wrong (rule tightened)"
    recurrence: 1

  - date: 2026-02-20
    story: STORY-F-3
    error: "Used Buffer type in packages/types/src/import/parser.types.ts — TS2580 because packages/types has no @types/node"
    rule: "Use Uint8Array instead of Buffer in shared type definitions. packages/types does not include @types/node."
    location: "Root CLAUDE.md → Things Claude Gets Wrong"
    recurrence: 0
