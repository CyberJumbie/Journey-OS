# STORY-AD-6: Student Alert View

**Epic:** E-45 (Advisor Cohort Dashboard & Interventions)
**Feature:** F-21
**Sprint:** 38
**Lane:** advisor (P5)
**Size:** M
**Old ID:** S-AD-45-5

---

## User Story
As a **medical student flagged as at-risk**, I need to see a notification with my risk areas and recommended study actions so that I can take proactive steps to improve before it becomes critical.

## Acceptance Criteria
- [ ] Alert banner on student dashboard when active risk flag exists
- [ ] Alert severity matches risk level: yellow (moderate), orange (high), red (critical)
- [ ] Alert content: "Areas needing attention" with top struggling concepts listed
- [ ] Recommended actions: specific study recommendations (practice X, review Y)
- [ ] Link to practice session pre-configured with recommended concepts
- [ ] Dismiss alert (marks as acknowledged by student, does not delete flag)
- [ ] Alert reappears if risk level escalates after dismissal
- [ ] Notification hook: in-app notification when new flag is generated
- [ ] Privacy: student sees their own flags only, no cohort comparison data
- [ ] Accessible: alert uses ARIA role="alert" for screen readers
- [ ] Supportive tone: "You're close to mastering X" not "You're failing at X"

## Reference Screens
> Refactor these prototype files for production.

| Prototype File | Production Target | Refactor Notes |
|---------------|-------------------|----------------|
| `.context/source/05-reference/app/app/pages/notifications/Notifications.tsx` | `apps/web/src/components/student/risk-alert-banner.tsx` | Use notification card pattern (icon + title + message + action buttons) but adapt for risk alerts. Replace generic notification types with severity-coded alert cards. Add dismiss + "Start Practice" action buttons instead of "View" + "Mark as Read". |

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/student/alert.types.ts`, `src/student/index.ts` |
| Service | apps/server | `src/modules/student/services/student-alert.service.ts` |
| Controller | apps/server | `src/modules/student/controllers/student-alert.controller.ts` |
| Route | apps/server | `src/modules/student/routes/student-alert.routes.ts` |
| Organism | apps/web | `src/components/student/risk-alert-banner.tsx` |
| Molecule | apps/web | `src/components/student/recommended-actions.tsx` |
| Hook | apps/web | `src/hooks/use-student-alerts.ts` |
| API Tests | apps/server | `src/modules/student/__tests__/student-alert.service.test.ts` |
| API Tests | apps/server | `src/modules/student/__tests__/student-alert.controller.test.ts` |

## Database Schema

**Supabase (read from risk_flags + new student_alert_dismissals):**
```sql
CREATE TABLE student_alert_dismissals (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL REFERENCES profiles(id),
  risk_flag_id UUID NOT NULL REFERENCES risk_flags(id),
  dismissed_at TIMESTAMPTZ DEFAULT now(),
  dismissed_risk_level VARCHAR(20) NOT NULL,  -- level at time of dismissal
  UNIQUE(student_id, risk_flag_id)
);

-- Enable RLS: students can only dismiss their own alerts
ALTER TABLE student_alert_dismissals ENABLE ROW LEVEL SECURITY;

CREATE POLICY "students_own_dismissals" ON student_alert_dismissals
  FOR ALL USING (student_id = auth.uid());
```

**No new Neo4j schema.**

## API Endpoints
| Method | Path | Description | Auth |
|--------|------|-------------|------|
| GET | `/api/student/alerts` | Get active alerts for current student | student |
| POST | `/api/student/alerts/:flagId/dismiss` | Dismiss an alert | student |
| GET | `/api/student/alerts/actions/:flagId` | Get recommended study actions for a flag | student |

## Dependencies
- **Blocked by:** STORY-AD-4 (risk flags must exist), Notification infrastructure (E-34, S-F-34-1)
- **Blocks:** None
- **Cross-epic:** Notification delivery via E-34, risk data from E-44, practice sessions from student lane (E-40)

## Testing Requirements
- 6 API tests: active alerts for student (own flags only), dismiss alert flow, alert reappears on escalation, recommended actions generation, privacy enforcement (cannot see other students' flags), empty state when no active flags
- 0 E2E tests

## Implementation Notes
- Alert banner is non-blocking: student can dismiss and continue using dashboard. Dismissal is soft -- the risk flag remains active for the advisor.
- Recommended actions are generated by the same recommendation engine (STORY-AD-7) but with student-facing language. The advisor sees "Refer to tutoring center" while the student sees "Visit the tutoring center for help with Cardiovascular Pharmacology."
- Privacy: API endpoint filters to `WHERE student_id = auth.uid()` -- enforced server-side via RLS and service-layer check.
- Tone must be supportive and encouraging per medical education best practices. Use positive framing: "Areas where extra practice will help" not "Areas you're failing."
- Alert reappearance logic: if a student dismissed a flag at "high" severity and the flag escalates to "critical", the alert reappears (check `dismissed_risk_level` vs current `risk_level`).
- The `use-student-alerts` hook polls on mount and at 5-minute intervals, or listens for SSE `risk_flag.created` events.
- ARIA attributes: `role="alert"` on the banner container, `aria-live="polite"` for dynamic updates, severity conveyed via `aria-label` not just color.
- Link to practice session uses URL params: `/student/practice?concepts=concept1,concept2` to pre-configure the practice session with recommended concepts.
