# S-F-11-1: Inngest Content Pipeline

**Epic:** E-11 (Content Processing Pipeline)
**Feature:** F-05
**Sprint:** 4
**Lane:** faculty (P3)
**Size:** L

## User Story
As a **Faculty member**, I need uploaded content automatically processed through a parse-clean-chunk-embed pipeline so that course materials are ready for AI concept extraction.

## Acceptance Criteria
- [ ] Inngest function triggered when content record status changes to `pending`
- [ ] Parse step: extract text from PDF (pdf-parse), PPTX (pptx-parser), DOCX (mammoth)
- [ ] Clean step: normalize whitespace, remove headers/footers, strip non-content elements
- [ ] Chunk step: 800-token chunks with 100-token overlap using tiktoken
- [ ] Embed step: generate 1024-dim embeddings via Voyage AI (voyage-3-large)
- [ ] Pipeline stages update content status: pending -> processing -> completed | error
- [ ] Error handling: retry up to 3 times for transient failures, mark as `error` after exhaustion
- [ ] Each step logs to structured pipeline log for debugging
- [ ] 12-15 API tests covering each pipeline stage, error handling, retry logic, status transitions

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/content/pipeline.types.ts` |
| Pipeline | apps/server | `src/pipelines/content.pipeline.ts` |
| Service - Parse | apps/server | `src/services/parse.service.ts` |
| Service - Clean | apps/server | `src/services/clean.service.ts` |
| Service - Chunk | apps/server | `src/services/chunk.service.ts` |
| Service - Embed | apps/server | `src/services/embed.service.ts` |
| Inngest Config | apps/server | `src/inngest/content.function.ts` |
| Tests | apps/server | `src/tests/content.pipeline.test.ts`, `src/tests/parse.service.test.ts`, `src/tests/chunk.service.test.ts` |

## Dependencies
- **Blocks:** S-F-11-2, S-F-11-3, S-F-11-4, S-F-12-1
- **Blocked by:** S-F-10-3 (content records must exist)
- **Cross-epic:** none

## Notes
- Inngest provides durable execution with built-in retry and step functions
- Chunking: 800 tokens measured by tiktoken (cl100k_base encoding), 100-token overlap for context continuity
- Embedding: all embeddings are 1024-dim per architecture rules (Voyage AI voyage-3-large)
- Pipeline stages are idempotent: re-running a step on the same content produces the same result
- Parse service uses factory pattern to select parser by MIME type
- Custom error classes: `ParseError`, `ChunkError`, `EmbedError`, `PipelineStageError`
- Each chunk stores: content_id, chunk_index, text, token_count, embedding vector
