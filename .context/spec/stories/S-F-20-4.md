# S-F-20-4: Batch Controls

**Epic:** E-20 (Bulk Generation)
**Feature:** F-09
**Sprint:** 14
**Lane:** faculty (P3)
**Size:** M

## User Story
As a **Faculty member**, I need pause, resume, and cancel controls for batch generation so that I can manage long-running batch jobs without losing completed work.

## Acceptance Criteria
- [ ] Pause button: stops dispatching new items, in-progress items complete
- [ ] Resume button: resumes dispatching from where paused
- [ ] Cancel button: stops all pending items, in-progress items complete, batch marked `cancelled`
- [ ] Confirmation dialog for cancel action (destructive)
- [ ] Paused state persisted: survives server restart via Inngest step state
- [ ] Status transitions: `running` → `paused` → `running` or `cancelled`
- [ ] Cancelled batch preserves all completed items (no data loss)
- [ ] Controls disabled when batch is in terminal state (completed/cancelled/failed)
- [ ] 8-12 API tests: pause/resume cycle, cancel with in-progress items, state persistence, status transitions
- [ ] TypeScript strict, named exports only

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/generation/batch-control.types.ts` |
| Service | apps/server | `src/services/generation/batch-control.service.ts` |
| Controller | apps/server | `src/controllers/generation/batch-control.controller.ts` |
| Inngest | apps/server | `src/inngest/functions/batch-control.fn.ts` |
| View | apps/web | `src/components/generation/BatchControls.tsx`, `src/components/generation/CancelConfirmDialog.tsx` |
| Tests | apps/server | `src/tests/generation/batch-control.test.ts` |

## Dependencies
- **Blocks:** none
- **Blocked by:** S-F-20-1 (batch pipeline exists to control)
- **Cross-epic:** none

## Notes
- Inngest pause/resume: use `step.waitForEvent('batch.resume')` pattern after pause signal
- Cancel sends `batch.cancel` event; orchestrator checks cancellation flag before each new dispatch
- In-progress items cannot be cancelled mid-LLM-call — they complete and result is kept
- Consider adding a "Retry Failed" button that re-dispatches only failed items from a completed batch
- Batch control endpoints: `POST /api/generation/batch/:batchId/pause|resume|cancel`
