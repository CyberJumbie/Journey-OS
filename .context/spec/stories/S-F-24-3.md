# S-F-24-3: Import Pipeline

**Epic:** E-24 (Legacy Import Pipeline)
**Feature:** F-11
**Sprint:** 17
**Lane:** faculty (P3)
**Size:** L

## User Story
As a **Faculty member**, I need an end-to-end import pipeline that parses, validates, tags, embeds, and dual-writes legacy questions so that imported items are fully integrated into the knowledge graph and item bank.

## Acceptance Criteria
- [ ] Pipeline stages: parse → validate → auto-tag → embed → dual-write
- [ ] Parse: apply field mapping to convert raw data to `ParsedQuestion[]`
- [ ] Validate: run validation engine (E-21) on each parsed question
- [ ] Auto-tag: apply auto-tagging service (E-21) for framework, Bloom, difficulty
- [ ] Embed: generate 1024-dim Voyage AI embeddings for each question
- [ ] Dual-write: Supabase `questions` table + Neo4j `Question` node with relationships
- [ ] Batch processing: Inngest function for async processing of large imports
- [ ] Progress tracking: per-item status with SSE updates
- [ ] Error handling: failed items logged with reason, successful items committed
- [ ] Import report generated on completion with accepted/rejected/skipped counts
- [ ] Custom error classes: `ImportPipelineError`, `ImportItemError`
- [ ] 12-18 API tests: full pipeline, each stage, partial failure, batch processing, dual-write sync
- [ ] TypeScript strict, named exports only

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/import/pipeline.types.ts` |
| Service | apps/server | `src/services/import/import-pipeline.service.ts`, `src/services/import/import-orchestrator.service.ts` |
| Inngest | apps/server | `src/inngest/functions/import-pipeline.fn.ts` |
| Repository | apps/server | `src/repositories/import-job.repository.ts` |
| Model | apps/server | `src/models/import-job.model.ts` |
| Errors | apps/server | `src/errors/import-pipeline.errors.ts` |
| Tests | apps/server | `src/tests/import/import-pipeline.test.ts`, `src/tests/import/import-orchestrator.test.ts` |

## Dependencies
- **Blocks:** S-F-24-4
- **Blocked by:** S-F-24-1 (parsers exist), S-F-21-4 (auto-tagging exists)
- **Cross-epic:** S-F-21-4 (Sprint 12 auto-tagging), S-F-21-1 (Sprint 12 validation)

## Notes
- Import pipeline reuses validation engine and auto-tagging from E-21 — DRY principle
- Embedding generation: batch API call to Voyage AI for efficiency (up to 128 texts per call)
- DualWriteService pattern: Supabase first → Neo4j second → sync_status = 'synced'
- Neo4j relationships created: `(Question)-[:IMPORTED_FROM]->(ImportJob)`, `(Question)-[:IN_COURSE]->(Course)`
- Imported questions enter as `draft` status — still go through critic/review pipeline
- Consider dedup check (E-21) as optional pipeline stage for imports
