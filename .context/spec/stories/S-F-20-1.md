# S-F-20-1: Inngest Batch Pipeline

**Epic:** E-20 (Bulk Generation)
**Feature:** F-09
**Sprint:** 14
**Lane:** faculty (P3)
**Size:** L

## User Story
As a **Faculty member**, I need an Inngest-powered batch generation pipeline with concurrency control so that I can generate large numbers of questions in parallel without overloading the system.

## Acceptance Criteria
- [ ] Inngest function `batch.generate` accepts batch config (target count, scope, parameters)
- [ ] Parallel execution with configurable concurrency limit (default: 5 simultaneous generations)
- [ ] Each item invokes the LangGraph.js pipeline (E-18) independently
- [ ] Batch state tracked in Supabase: `batch_jobs` table with status, progress, error counts
- [ ] Individual item results linked to batch via `batch_id` foreign key
- [ ] Failed items retried up to 2 times before marking as `batch_item_failed`
- [ ] Batch completion triggers `batch.complete` event for downstream consumers
- [ ] Rate limiting: respect LLM provider rate limits with token bucket pattern
- [ ] Idempotency: re-running a batch skips already-completed items
- [ ] Custom error classes: `BatchPipelineError`, `BatchItemError`, `ConcurrencyLimitError`
- [ ] 12-18 API tests: batch creation, concurrency control, item retry, completion event, idempotency, rate limiting
- [ ] TypeScript strict, named exports only

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/generation/batch.types.ts` |
| Model | apps/server | `src/models/batch-job.model.ts` |
| Repository | apps/server | `src/repositories/batch-job.repository.ts` |
| Service | apps/server | `src/services/generation/batch-pipeline.service.ts`, `src/services/generation/batch-orchestrator.service.ts` |
| Inngest | apps/server | `src/inngest/functions/batch-generate.fn.ts`, `src/inngest/functions/batch-item.fn.ts` |
| Events | apps/server | `src/inngest/events/batch.events.ts` |
| Errors | apps/server | `src/errors/batch.errors.ts` |
| Tests | apps/server | `src/tests/generation/batch-pipeline.test.ts`, `src/tests/generation/batch-orchestrator.test.ts` |

## Dependencies
- **Blocks:** S-F-20-2, S-F-20-3, S-F-20-4
- **Blocked by:** S-F-18-1 (generation pipeline exists)
- **Cross-epic:** S-F-18-1 (Sprint 6 pipeline)

## Notes
- Inngest fan-out pattern: `batch.generate` emits N `batch.item.generate` events, each processed independently
- Concurrency managed via Inngest's `concurrency` option on the step function
- Batch status transitions: `pending` → `running` → `completed` | `completed_with_errors` | `failed`
- Token bucket for LLM rate limiting: shared across all concurrent items in a batch
- Consider Inngest's `step.waitForEvent` for coordinating batch completion
- Each generated item still goes through validation (E-21) and critic (E-22) pipelines
