# S-AD-44-2: Trajectory Analysis Service

**Epic:** E-44 (Risk Prediction Engine)
**Feature:** F-21
**Sprint:** 37
**Lane:** advisor (P5)
**Size:** M

## User Story
As a **system**, I need to analyze mastery trajectories over time to detect declining trends so that risk predictions incorporate temporal patterns beyond point-in-time snapshots.

## Acceptance Criteria
- [ ] Trajectory computation: linear regression slope per concept over sliding window
- [ ] Configurable window size: default 14 days, adjustable
- [ ] Trend classification: improving (slope > 0.01), stable (-0.01 to 0.01), declining (slope < -0.01)
- [ ] Aggregate trajectory: overall student trend across all concepts
- [ ] Acceleration detection: declining faster than previous window (second derivative)
- [ ] Inactivity detection: no practice in > 7 days flagged as risk signal
- [ ] API endpoint: GET /api/risk/trajectory/:studentId
- [ ] Batch computation for all active students (Inngest job)
- [ ] Output feeds into GNN model as node features
- [ ] Performance: compute trajectory for 1000 students in < 30 seconds

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/python-api | `src/models/trajectory_types.py` |
| Algorithm | packages/python-api | `src/algorithms/trajectory_analysis.py` |
| Service | packages/python-api | `src/services/trajectory_service.py` |
| Route | packages/python-api | `src/routes/trajectory.py` |
| Job | packages/python-api | `src/jobs/trajectory_batch_job.py` |
| Tests | packages/python-api | `tests/test_trajectory_analysis.py` |
| Tests | packages/python-api | `tests/test_trajectory_service.py` |

## Dependencies
- **Blocks:** none (feeds into S-AD-44-1 as feature)
- **Blocked by:** S-AD-44-1 (risk model framework), S-ST-40-3 (mastery history data)
- **Cross-epic:** Mastery history from BKT service (E-40)

## Notes
- Uses numpy for linear regression (polyfit degree 1) and scipy for statistical tests.
- Trajectory data fetched from Supabase mastery_history table (time series).
- Inactivity is a strong predictor of academic risk in medical education literature.
- Second derivative (acceleration) catches students whose decline is accelerating.
