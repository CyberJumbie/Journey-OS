# S-F-38-2: Notification Preferences

**Epic:** E-38 (Profile & Preferences)
**Feature:** F-18
**Sprint:** 19
**Lane:** faculty (P3)
**Size:** S

## User Story
As a **Faculty member**, I need per-type notification preference toggles so that I can control which notifications I receive and through which channels.

## Acceptance Criteria
- [ ] Preference matrix: notification types as rows, channels as columns (in-app, email, off)
- [ ] Notification types: batch_complete, review_request, review_decision, gap_scan, lint_alert, system
- [ ] Default: all types enabled for in-app, email off
- [ ] Toggle saves immediately (optimistic update with rollback)
- [ ] Preferences stored in Supabase `user_preferences` table as JSONB
- [ ] NotificationService checks preferences before sending
- [ ] Reset to defaults button
- [ ] 5-8 API tests: preference read, update, NotificationService respects preferences, reset
- [ ] TypeScript strict, named exports only

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/user/notification-prefs.types.ts` |
| Service | apps/server | `src/services/user/notification-prefs.service.ts` |
| Controller | apps/server | `src/controllers/user/preferences.controller.ts` |
| View | apps/web | `src/app/(dashboard)/settings/notifications/page.tsx`, `src/components/settings/NotificationPrefsMatrix.tsx` |
| Tests | apps/server | `src/tests/user/notification-prefs.test.ts` |

## Dependencies
- **Blocks:** none
- **Blocked by:** S-F-38-1 (profile page exists as settings parent)
- **Cross-epic:** S-F-34-2 (notification service reads preferences)

## Notes
- Preference matrix: shadcn/ui Toggle or Switch components in a table layout
- Email channel placeholder: save preference but email delivery not implemented until email service is added
- JSONB structure: `{ batch_complete: { in_app: true, email: false }, ... }`
- NotificationService.push() checks `notification-prefs.service.getPreferences(userId, type)` before creating
- Settings URL: `/settings/notifications` â€” tab under settings layout
- Consider "Quiet hours" setting for future enhancement (not in scope)
