# S-F-11-4: Dual-Write Chunks

**Epic:** E-11 (Content Processing Pipeline)
**Feature:** F-05
**Sprint:** 4
**Lane:** faculty (P3)
**Size:** M

## User Story
As a **Faculty member**, I need processed content chunks written to both Supabase and Neo4j so that they are available for both relational queries and graph traversal.

## Acceptance Criteria
- [ ] Chunk TypeScript types: id, content_id, chunk_index, text, token_count, embedding, sync_status
- [ ] ChunkRepository with create and read operations for Supabase
- [ ] Neo4j Chunk node creation with properties: id, chunk_index, text, token_count
- [ ] Neo4j relationship: `(Content)-[:HAS_CHUNK]->(Chunk)` with chunk_index ordering
- [ ] DualWriteService integration: Supabase first, Neo4j second, sync_status = 'synced'
- [ ] Embedding stored in Supabase pgvector; Neo4j stores chunk without embedding (graph traversal only)
- [ ] Batch write: process all chunks for a content record in a single transaction per store
- [ ] 10-12 API tests for dual-write, sync_status verification, batch creation, rollback on Neo4j failure

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/content/chunk.types.ts` |
| Model | apps/server | `src/models/chunk.model.ts` |
| Repository | apps/server | `src/repositories/chunk.repository.ts` |
| Service | apps/server | `src/services/chunkWriter.service.ts` |
| Tests | apps/server | `src/tests/chunkWriter.service.test.ts` |

## Dependencies
- **Blocks:** S-F-12-1
- **Blocked by:** S-F-11-1 (pipeline produces chunks)
- **Cross-epic:** none

## Notes
- DualWriteService pattern: Supabase first (source of truth), Neo4j second (graph projection)
- Neo4j Chunk label: `Chunk` (PascalCase per convention)
- Embedding NOT stored in Neo4j -- pgvector in Supabase handles all vector operations
- Batch write uses Supabase `.insert()` for multiple rows and Neo4j `UNWIND` for batch node creation
- On Neo4j failure: sync_status = 'pending_sync', background job retries
- Chunk ordering preserved via chunk_index for reconstruction of original document flow
