# S-F-12-3: Dedup Service

**Epic:** E-12 (AI Concept Extraction)
**Feature:** F-06
**Sprint:** 5
**Lane:** faculty (P3)
**Size:** M

## User Story
As a **Faculty member**, I need duplicate SubConcepts automatically merged so that the concept graph stays clean without redundant entries.

## Acceptance Criteria
- [ ] DedupService computes cosine similarity between SubConcept embeddings
- [ ] Dedup threshold: 0.92 cosine similarity triggers merge candidate
- [ ] Merge strategy: keep the SubConcept with higher confidence score, redirect relationships from duplicate
- [ ] Embedding for SubConcepts generated using Voyage AI (same 1024-dim as content chunks)
- [ ] pgvector query: find nearest neighbors above 0.92 threshold
- [ ] Merge audit: record which SubConcepts were merged and why
- [ ] Batch dedup: run after extraction completes for a content record
- [ ] 10-12 API tests covering dedup detection, merge execution, audit trail, threshold boundary cases

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/concept/dedup.types.ts` |
| Service | apps/server | `src/services/dedup.service.ts` |
| Repository | apps/server | `src/repositories/dedup.repository.ts` |
| Tests | apps/server | `src/tests/dedup.service.test.ts` |

## Dependencies
- **Blocks:** none
- **Blocked by:** S-F-12-1 (SubConcepts must exist to dedup)
- **Cross-epic:** none

## Notes
- Cosine similarity threshold of 0.92 is intentionally high to avoid false positive merges
- pgvector query: `SELECT * FROM subconcepts WHERE embedding <=> $1 < 0.08` (1 - 0.92 = 0.08 distance)
- Merge redirects all relationships (MAPPED_TO, TEACHES, HAS_CHUNK source) from duplicate to survivor
- Neo4j merge: delete duplicate node, redirect all edges to survivor node
- DualWriteService handles merge in both stores: Supabase soft-delete duplicate, Neo4j DETACH DELETE + re-link
- Dedup runs within the same Inngest pipeline as extraction, as a post-extraction step
