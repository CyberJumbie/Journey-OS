# S-ST-40-3: BKT Mastery Estimation

**Epic:** E-40 (BKT & IRT Engine)
**Feature:** F-19
**Sprint:** 31
**Lane:** student (P4)
**Size:** L

## User Story
As a **system**, I need to track per-concept mastery for each student using Bayesian Knowledge Tracing so that the adaptive engine knows which concepts the student has mastered and which need more practice.

## Acceptance Criteria
- [ ] BKT model with 4 parameters per concept: P(L0), P(T), P(G), P(S)
- [ ] P(L0): prior probability of knowing concept before practice
- [ ] P(T): probability of transitioning from unlearned to learned
- [ ] P(G): probability of guessing correctly without knowing
- [ ] P(S): probability of slipping (incorrect despite knowing)
- [ ] Real-time mastery update after each student response
- [ ] Mastery threshold: P(L) >= 0.95 considered mastered
- [ ] Per-concept mastery state stored per student in Supabase
- [ ] Neo4j update: (Student)-[:HAS_MASTERY {level: float}]->(Concept)
- [ ] Batch parameter fitting from historical response data (EM algorithm)
- [ ] API endpoint: POST /api/bkt/update (single response), GET /api/bkt/mastery/:studentId
- [ ] Performance: mastery update in < 100ms per response
- [ ] Mastery history log for trend analysis

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/python-api | `src/models/bkt_types.py` |
| Algorithm | packages/python-api | `src/algorithms/bkt.py` |
| Algorithm | packages/python-api | `src/algorithms/bkt_parameter_fitting.py` |
| Service | packages/python-api | `src/services/bkt_mastery_service.py` |
| Repository | packages/python-api | `src/repositories/mastery_repository.py` |
| Route | packages/python-api | `src/routes/bkt.py` |
| Tests | packages/python-api | `tests/test_bkt.py` |
| Tests | packages/python-api | `tests/test_bkt_mastery_service.py` |
| Tests | packages/python-api | `tests/test_mastery_repository.py` |

## Dependencies
- **Blocks:** S-ST-42-2 (replaces mock mastery), S-AD-44-1 (risk engine needs mastery data)
- **Blocked by:** S-ST-40-1 (FastAPI scaffold)
- **Cross-epic:** Feeds into student dashboard (E-42), risk prediction (E-44)

## Notes
- BKT is a Hidden Markov Model; forward algorithm computes P(L_n | observations).
- DualWriteService pattern in Python: Supabase first, Neo4j second.
- Parameter fitting uses EM; initial parameters can be seeded from literature defaults.
- Default parameters: P(L0)=0.1, P(T)=0.2, P(G)=0.25, P(S)=0.1.
- Mastery history enables trend analysis for E-43 and risk prediction for E-44.
