# S-F-34-2: Socket.io Notification Service

**Epic:** E-34 (Notification System)
**Feature:** F-16
**Sprint:** 19
**Lane:** faculty (P3)
**Size:** M

## User Story
As a **Faculty member**, I need real-time push notifications via Socket.io so that I receive instant alerts for important events without refreshing the page.

## Acceptance Criteria
- [ ] Socket.io server integration on Express app
- [ ] Authenticated connections: validate JWT on socket handshake
- [ ] User-scoped rooms: each user joins a personal notification room on connect
- [ ] NotificationService.push(): creates notification record + emits to user's socket room
- [ ] Event format: `notification:new` with full notification payload
- [ ] Connection lifecycle: join room on connect, leave on disconnect, handle reconnection
- [ ] Offline handling: notifications persisted to DB regardless of connection status
- [ ] Online presence tracking: maintain set of connected user IDs
- [ ] Custom error class: `SocketNotificationError`
- [ ] 8-12 API tests: connection auth, room join, push delivery, offline persistence, reconnection
- [ ] TypeScript strict, named exports only

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/notification/socket.types.ts` |
| Service | apps/server | `src/services/notification/notification.service.ts`, `src/services/notification/socket-manager.service.ts` |
| Middleware | apps/server | `src/middleware/socket-auth.middleware.ts` |
| Config | apps/server | `src/config/socket.config.ts` |
| Errors | apps/server | `src/errors/socket.errors.ts` |
| Tests | apps/server | `src/tests/notification/notification.service.test.ts`, `src/tests/notification/socket-manager.test.ts` |

## Dependencies
- **Blocks:** S-F-35-1
- **Blocked by:** S-F-34-1 (notification model exists)
- **Cross-epic:** S-F-35-1 (Sprint 19 room management builds on this)

## Notes
- Socket.io used for presence and notifications only — SSE used for streaming generation events
- JWT validation on handshake: extract token from `auth.token` in socket handshake
- User room naming: `user:{userId}` — predictable, scoped, secure
- Online presence: in-memory Set of connected user IDs (sufficient for single-server; Redis adapter for multi-server)
- Consider Socket.io adapter (Redis) for horizontal scaling in production
- Reconnection: Socket.io client auto-reconnects; server re-adds to room on reconnect handshake
