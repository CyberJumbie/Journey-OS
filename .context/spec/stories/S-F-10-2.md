# S-F-10-2: Supabase Storage Integration

**Epic:** E-10 (Upload & Storage)
**Feature:** F-05
**Sprint:** 4
**Lane:** faculty (P3)
**Size:** M

## User Story
As a **Faculty member**, I need uploaded files stored securely in WORM storage with presigned URLs so that originals are immutable and downloadable when needed.

## Acceptance Criteria
- [ ] Supabase Storage bucket `content-originals` configured with WORM (write-once-read-many) policy
- [ ] StorageService uploads files to bucket with structured key: `{institution_id}/{course_id}/{file_id}/{original_filename}`
- [ ] Presigned URL generation for secure, time-limited download access (1-hour expiry)
- [ ] Upload returns storage path and file metadata (size, MIME type, checksum)
- [ ] SHA-256 checksum computed and stored for integrity verification
- [ ] Malware scan placeholder: interface defined, implementation deferred
- [ ] Storage cleanup: no deletion allowed (WORM), only soft-delete of content record
- [ ] 8-10 API tests for upload-to-storage, presigned URL generation, checksum verification, WORM enforcement

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/content/storage.types.ts` |
| Service | apps/server | `src/services/storage.service.ts` |
| Repository | apps/server | `src/repositories/storage.repository.ts` |
| Tests | apps/server | `src/tests/storage.service.test.ts` |

## Dependencies
- **Blocks:** S-F-10-3
- **Blocked by:** S-F-10-1 (upload controller passes files to storage)
- **Cross-epic:** none

## Notes
- WORM policy means no overwrite, no delete at the storage level
- Presigned URLs use Supabase `createSignedUrl` with 3600s expiry
- Checksum stored in content record for later integrity checks
- Malware scan interface: `IMalwareScanService.scan(fileBuffer): Promise<ScanResult>` -- stubbed with pass-through for now
- Storage path convention ensures files are organized by institution and course
- All Supabase operations through Supabase client, never raw SQL for storage
