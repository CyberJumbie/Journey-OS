# S-F-21-2: Self-Correction Retry

**Epic:** E-21 (Validation & Dedup Engine)
**Feature:** F-10
**Sprint:** 12
**Lane:** faculty (P3)
**Size:** M

## User Story
As a **Faculty member**, I need the system to automatically retry LLM generation up to 2 times when validation rules fail so that minor issues are self-corrected without manual intervention.

## Acceptance Criteria
- [ ] Self-correction service accepts a `QuestionDraft` + `ValidationResult` with errors
- [ ] Constructs a correction prompt including violation details and original draft
- [ ] Up to 2 retry attempts before marking as `needs_manual_review`
- [ ] Each retry re-runs full validation suite on corrected output
- [ ] Retry metadata tracked: attempt count, violations per attempt, correction diff
- [ ] Only `error`-severity violations trigger retries (warnings pass through)
- [ ] Circuit breaker: if same rule fails on all retries, flag rule + question for human review
- [ ] Custom error class: `SelfCorrectionError`
- [ ] 8-12 API tests: successful correction, max retries exhausted, partial fix, circuit breaker, metadata tracking
- [ ] TypeScript strict, named exports only

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/validation/correction.types.ts` |
| Service | apps/server | `src/services/validation/self-correction.service.ts` |
| LLM | apps/server | `src/services/validation/correction-prompt.builder.ts` |
| Errors | apps/server | `src/errors/correction.errors.ts` |
| Tests | apps/server | `src/tests/validation/self-correction.test.ts` |

## Dependencies
- **Blocks:** S-F-22-1
- **Blocked by:** S-F-21-1 (validation engine exists)
- **Cross-epic:** none

## Notes
- Correction prompt should include the specific rule violations and their suggestions
- LLM call uses same provider as generation pipeline (Claude via LangChain)
- Track token usage per correction attempt for cost monitoring
- Retry delay: immediate (no backoff needed since these are independent LLM calls)
- State transition: `draft` → `correcting` → `validated` or `needs_manual_review`
