# S-SA-04-3: Approval Workflow

**Epic:** E-04 (Institution Lifecycle)
**Feature:** F-02
**Sprint:** 3
**Lane:** superadmin (P1)
**Size:** M

## User Story
As a **SuperAdmin**, I need to approve an institution application so that the institution record is created and an invitation email is dispatched to the designated admin contact.

## Acceptance Criteria
- [ ] Approve action transitions application status: pending -> approved
- [ ] InstitutionService creates new institution record in Supabase
- [ ] DualWriteService creates Institution node in Neo4j
- [ ] Institution record includes: name, type, accreditation_body, status='active'
- [ ] Invitation email dispatched to application contact with admin role
- [ ] Invitation record created with: token, role=institutional_admin, institution_id, expires_at
- [ ] Email contains branded invitation link: /invite/accept?token=xxx
- [ ] Approval timestamp and approving SuperAdmin ID recorded
- [ ] Optimistic UI update on approve button click
- [ ] 10 API tests: successful approval, institution creation, dual-write, invitation creation, email dispatch mock, status transition, duplicate approval prevention, auth enforcement, invalid application ID, rollback on failure

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | src/institution/institution.types.ts |
| Model | apps/server | src/models/institution.model.ts |
| Repository | apps/server | src/repositories/institution.repository.ts |
| Service | apps/server | src/services/institution/institution.service.ts, src/services/email/invitation-email.service.ts |
| Controller | apps/server | src/controllers/institution/approval.controller.ts |
| Tests | apps/server | src/services/institution/__tests__/institution.service.test.ts, src/controllers/institution/__tests__/approval.controller.test.ts |

## Dependencies
- **Blocks:** S-IA-06-1, S-U-02-2
- **Blocked by:** S-SA-04-2
- **Cross-epic:** S-U-02-2 (invitation acceptance flow consumes the token created here)

## Notes
- DualWriteService pattern: Supabase institution first -> Neo4j Institution node second.
- Email service should be abstracted for swappable providers (Resend, SendGrid, etc.).
- Rollback strategy: if Neo4j write fails, mark sync_status='pending' and queue for retry.
- Prevent double-approval: check status before processing (optimistic locking).
