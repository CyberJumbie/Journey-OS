# S-F-21-1: Validation Rule Engine

**Epic:** E-21 (Validation & Dedup Engine)
**Feature:** F-10
**Sprint:** 12
**Lane:** faculty (P3)
**Size:** L

## User Story
As a **Faculty member**, I need a validation engine that applies 30 rules (22 NBME + 8 extended) with severity levels to generated questions so that only structurally and pedagogically sound items proceed to review.

## Acceptance Criteria
- [ ] 22 NBME rules implemented: stem clarity, distractor plausibility, answer-choice homogeneity, negation detection, absolute-term flagging, item-writing flaw detection, etc.
- [ ] 8 extended rules implemented: vignette relevance, rationale completeness, Bloom-level consistency, difficulty calibration, bias language detection, formatting standards, metadata completeness, concept alignment
- [ ] Each rule returns `{ ruleId, severity: 'error' | 'warning' | 'info', message, field, suggestion }`
- [ ] Severity levels: `error` blocks progression, `warning` flags for review, `info` is advisory
- [ ] Rule engine accepts a `QuestionDraft` and returns `ValidationResult` with all violations
- [ ] Rules are composable and can be enabled/disabled per institution config
- [ ] Rule registry with named exports for each rule function
- [ ] Custom error classes: `ValidationEngineError`, `RuleExecutionError`
- [ ] 15-20 API tests: each rule category, severity escalation, rule composition, config override, error paths
- [ ] TypeScript strict, named exports only, OOP with constructor DI

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/validation/rule.types.ts`, `src/validation/result.types.ts` |
| Model | apps/server | `src/models/validation-result.model.ts` |
| Rules | apps/server | `src/services/validation/rules/nbme-rules.ts`, `src/services/validation/rules/extended-rules.ts` |
| Service | apps/server | `src/services/validation/validation-engine.service.ts`, `src/services/validation/rule-registry.service.ts` |
| Config | apps/server | `src/config/validation.config.ts` |
| Errors | apps/server | `src/errors/validation.errors.ts` |
| Tests | apps/server | `src/tests/validation/validation-engine.test.ts`, `src/tests/validation/nbme-rules.test.ts`, `src/tests/validation/extended-rules.test.ts` |

## Dependencies
- **Blocks:** S-F-21-2, S-F-22-1
- **Blocked by:** S-F-18-3 (review nodes exist, pipeline functional)
- **Cross-epic:** S-F-18-3 (Sprint 6 pipeline)

## Notes
- NBME item-writing flaws reference: Haladyna & Downing taxonomy of item-writing flaws
- Rules should be pure functions for testability; the engine orchestrates execution order
- Some rules require async (e.g., concept alignment needs Neo4j lookup) â€” engine must handle mixed sync/async rules
- Rule config stored per institution in Supabase `institution_settings` table
- Severity escalation: 3+ warnings on same field auto-promote to error
