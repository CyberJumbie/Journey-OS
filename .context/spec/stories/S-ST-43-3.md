# S-ST-43-3: Comparative Percentile

**Epic:** E-43 (Student Progress Analytics)
**Feature:** F-20
**Sprint:** 28
**Lane:** student (P4)
**Size:** M

## User Story
As a **medical student**, I need to see how my performance compares to my cohort (anonymized) so that I can understand my relative standing and adjust my study strategy.

## Acceptance Criteria
- [ ] Opt-in toggle for comparative analytics (default: off)
- [ ] Percentile rank displayed per USMLE system (e.g., "72nd percentile")
- [ ] Bell curve visualization showing student's position in cohort distribution
- [ ] Overall percentile rank across all systems
- [ ] Anonymized: no individual student data exposed, only aggregate statistics
- [ ] Minimum cohort size of 10 before percentiles are shown (privacy)
- [ ] Privacy notice explaining data usage before opt-in
- [ ] Opt-in preference stored in user profile (Supabase)
- [ ] Service computes percentiles from anonymized aggregate queries
- [ ] Loading state and empty state (insufficient cohort data)

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/student/analytics.types.ts` (extend) |
| Service | apps/server | `src/modules/student/services/comparative-percentile.service.ts` |
| Controller | apps/server | `src/modules/student/controllers/student-analytics.controller.ts` (extend) |
| View | apps/web | `src/components/student/comparative-percentile.tsx` |
| Component | apps/web | `src/components/student/percentile-bell-curve.tsx` |
| Component | apps/web | `src/components/student/opt-in-toggle.tsx` |
| API Tests | apps/server | `src/modules/student/__tests__/comparative-percentile.service.test.ts` |
| API Tests | apps/server | `src/modules/student/__tests__/comparative-percentile.privacy.test.ts` |

## Dependencies
- **Blocks:** none
- **Blocked by:** S-ST-42-1 (dashboard exists)
- **Cross-epic:** none

## Notes
- Privacy is critical: aggregate queries only, never expose individual scores.
- Percentile computation uses Supabase SQL aggregation with `PERCENT_RANK()`.
- Minimum cohort size (10) prevents de-anonymization in small classes.
- Opt-in preference stored in `user_preferences` table in Supabase.
