# S-ST-40-4: Adaptive Item Selection

**Epic:** E-40 (BKT & IRT Engine)
**Feature:** F-19
**Sprint:** 31
**Lane:** student (P4)
**Size:** M

## User Story
As a **system**, I need to select the next practice item by targeting the student's weakest concepts while respecting prerequisite chains so that practice sessions are maximally efficient for learning.

## Acceptance Criteria
- [ ] Item selection algorithm: weakest-concept-first with prerequisite awareness
- [ ] Query Neo4j prerequisite graph: (Concept)-[:PREREQUISITE_OF]->(Concept)
- [ ] If prerequisite concept not mastered, prioritize it over dependent concept
- [ ] Within a concept, select item with optimal difficulty (IRT information maximization)
- [ ] Fisher information function: I(theta) = a^2 * P * Q for item information
- [ ] Avoid recently shown items (exposure control: no repeat within 20 items)
- [ ] Concept diversity: rotate across weak concepts, don't over-drill one
- [ ] API endpoint: GET /api/adaptive/next-item/:sessionId
- [ ] Response includes: item_id, concept_id, expected_difficulty, rationale
- [ ] Performance: item selection in < 200ms including Neo4j traversal
- [ ] Fallback: random selection if all concepts mastered or item pool exhausted

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/python-api | `src/models/adaptive_types.py` |
| Algorithm | packages/python-api | `src/algorithms/adaptive_selector.py` |
| Algorithm | packages/python-api | `src/algorithms/prerequisite_traversal.py` |
| Service | packages/python-api | `src/services/adaptive_selection_service.py` |
| Route | packages/python-api | `src/routes/adaptive.py` |
| Tests | packages/python-api | `tests/test_adaptive_selector.py` |
| Tests | packages/python-api | `tests/test_prerequisite_traversal.py` |
| Tests | packages/python-api | `tests/test_adaptive_selection_service.py` |

## Dependencies
- **Blocks:** S-ST-41-1 (practice launcher needs item selection)
- **Blocked by:** S-ST-40-1 (FastAPI scaffold), S-ST-40-2 (calibrated item parameters), S-ST-40-3 (mastery state)
- **Cross-epic:** none

## Notes
- Neo4j Cypher for prerequisite traversal: MATCH path=(c:Concept)-[:PREREQUISITE_OF*1..3]->(target) WHERE target.id = $conceptId RETURN path.
- Fisher information maximization selects items where student ability matches item difficulty.
- Exposure control prevents item overuse; track shown items per session in memory.
- Prerequisite depth limit: 3 levels to prevent deep chain traversal bottlenecks.
