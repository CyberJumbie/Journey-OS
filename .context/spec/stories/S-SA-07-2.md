# S-SA-07-2: User Reassignment

**Epic:** E-07 (Cross-Institution User Management)
**Feature:** F-03
**Sprint:** 3
**Lane:** superadmin (P1)
**Size:** M

## User Story
As a **SuperAdmin**, I need to reassign a user from one institution to another so that faculty or staff transfers are handled without losing their account data.

## Acceptance Criteria
- [ ] Reassign action on user detail page (SuperAdmin only)
- [ ] Target institution selected from dropdown of active institutions
- [ ] Confirmation dialog shows: user, current institution, target institution, impact summary
- [ ] ReassignmentService updates institution_id in Supabase user profile
- [ ] DualWriteService updates Neo4j: remove old (Person)-[:BELONGS_TO]->(Institution), create new
- [ ] Course associations from old institution are archived (not deleted)
- [ ] User retains their role unless explicitly changed during reassignment
- [ ] Audit log: reassignment event with from_institution, to_institution, timestamp, admin_id
- [ ] Notification email sent to user about institution change
- [ ] 10 API tests: successful reassignment, dual-write, audit log, notification mock, same-institution rejection, invalid institution, auth enforcement, course archival, role preservation, concurrent reassignment guard

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | src/user/reassignment.types.ts |
| Service | apps/server | src/services/user/user-reassignment.service.ts, src/services/email/reassignment-email.service.ts |
| Controller | apps/server | src/controllers/user/user-reassignment.controller.ts |
| View | apps/web | src/app/(protected)/admin/users/[id]/reassign/page.tsx |
| Components | packages/ui | src/components/modals/reassignment-confirm-modal.tsx |
| Tests | apps/server | src/services/user/__tests__/user-reassignment.service.test.ts, src/controllers/user/__tests__/user-reassignment.controller.test.ts |

## Dependencies
- **Blocks:** none
- **Blocked by:** S-SA-07-1
- **Cross-epic:** none

## Notes
- Reassignment is a complex operation: must handle course associations, pending invitations, and role context.
- Neo4j relationship update: DELETE old BELONGS_TO, CREATE new BELONGS_TO in same transaction.
- Course archival: set course_membership.status='archived' for old institution courses.
- Edge case: user with Course Director flag should have CD flag reset on reassignment (CD is institution-scoped).
