# S-AD-44-1: GNN Risk Model

**Epic:** E-44 (Risk Prediction Engine)
**Feature:** F-21
**Sprint:** 37
**Lane:** advisor (P5)
**Size:** L

## User Story
As a **system**, I need a graph neural network model that classifies student risk levels from mastery graph data so that at-risk students can be identified 2-4 weeks before academic failure.

## Acceptance Criteria
- [ ] PyTorch Geometric GNN model for student risk classification
- [ ] Input: student-concept mastery graph from Neo4j
- [ ] Node features: concept mastery level, trend slope, time since last practice
- [ ] Edge features: prerequisite strength, concept similarity
- [ ] Output: risk classification (low, moderate, high, critical) with confidence
- [ ] Model architecture: 2-layer GraphSAGE with global mean pooling
- [ ] Training pipeline: labeled historical data (student outcomes)
- [ ] Evaluation metrics: precision >= 80%, recall >= 75%, lead time >= 2 weeks
- [ ] Model versioning: store model artifacts with version and metrics
- [ ] Inference endpoint: POST /api/risk/predict/:studentId
- [ ] Batch inference: predict for all active students
- [ ] Model retraining scheduled via Inngest (monthly or on-demand)

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/python-api | `src/models/risk_types.py` |
| Model | packages/python-api | `src/ml/risk_gnn.py` |
| Training | packages/python-api | `src/ml/risk_training.py` |
| Data | packages/python-api | `src/ml/risk_data_loader.py` |
| Service | packages/python-api | `src/services/risk_prediction_service.py` |
| Repository | packages/python-api | `src/repositories/risk_repository.py` |
| Route | packages/python-api | `src/routes/risk.py` |
| Tests | packages/python-api | `tests/test_risk_gnn.py` |
| Tests | packages/python-api | `tests/test_risk_prediction_service.py` |
| Tests | packages/python-api | `tests/test_risk_data_loader.py` |

## Dependencies
- **Blocks:** S-AD-44-2, S-AD-44-3, S-AD-44-4
- **Blocked by:** S-ST-40-3 (BKT mastery data needed as input features)
- **Cross-epic:** Reuses FastAPI scaffold from S-ST-40-1

## Notes
- PyTorch Geometric for graph neural network; GraphSAGE is preferred for inductive learning.
- Neo4j to PyTorch Geometric conversion: extract subgraph per student, convert to `torch_geometric.data.Data`.
- Initial training data may be synthetic/simulated until real outcome data accumulates.
- Model artifacts stored in Supabase Storage (or S3); metadata in Supabase table.
- Risk classification thresholds: P(fail) < 0.2 = low, 0.2-0.4 = moderate, 0.4-0.7 = high, > 0.7 = critical.
