# S-U-01-2: Express Auth Middleware

**Epic:** E-01 (Auth Infrastructure)
**Feature:** F-01
**Sprint:** 3
**Lane:** universal (P0)
**Size:** M

## User Story
As a **platform engineer**, I need Express middleware that verifies JWT tokens, extracts the user role, and populates `req.user` so that downstream controllers can identify the authenticated user.

## Acceptance Criteria
- [ ] AuthMiddleware class verifies Supabase JWT on every protected request
- [ ] Invalid/expired tokens return 401 Unauthorized with structured error
- [ ] Missing Authorization header returns 401 with clear message
- [ ] `req.user` populated with: id, email, role, institution_id, metadata
- [ ] Role extracted from `app_metadata.role` in JWT claims
- [ ] TypeScript augmentation for Express Request type to include `user` property
- [ ] AuthService wraps Supabase auth operations (verify, decode, refresh)
- [ ] Custom UnauthorizedError class (not raw Error)
- [ ] 10 API tests: valid token, expired token, malformed token, missing header, role extraction, institution scoping, token refresh edge case, invalid signature, empty bearer, OPTIONS passthrough

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | src/auth/auth-request.types.ts |
| Middleware | apps/server | src/middleware/auth.middleware.ts |
| Service | apps/server | src/services/auth/auth.service.ts |
| Errors | apps/server | src/errors/unauthorized.error.ts |
| Tests | apps/server | src/middleware/__tests__/auth.middleware.test.ts |

## Dependencies
- **Blocks:** S-U-01-3
- **Blocked by:** S-U-01-1
- **Cross-epic:** All Sprint 3+ API stories depend on this middleware

## Notes
- Constructor DI: AuthMiddleware receives AuthService via constructor injection.
- Named export only: `export { AuthMiddleware }`.
- Middleware pattern: `(req, res, next) => authMiddleware.handle(req, res, next)`.
- Do not skip MVC layers; the middleware delegates to AuthService for token verification.
- OPTIONS requests should pass through without auth for CORS preflight.
