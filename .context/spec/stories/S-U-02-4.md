# S-U-02-4: Email Verification Gate

**Epic:** E-02 (Registration & Onboarding)
**Feature:** F-01
**Sprint:** 3
**Lane:** universal (P0)
**Size:** S

## User Story
As a **newly registered user**, I need to verify my email address before gaining full platform access so that the system confirms my identity and prevents fraudulent registrations.

## Acceptance Criteria
- [ ] Unverified users see a "Verify your email" interstitial after login
- [ ] Interstitial shows: email address, resend button, check spam instructions
- [ ] Resend verification email with rate limit (max 3 per 10 minutes)
- [ ] Verification link callback updates user's email_verified flag
- [ ] Verified users bypass the interstitial on subsequent logins
- [ ] Express middleware blocks API access for unverified users (except auth endpoints)
- [ ] Custom EmailNotVerifiedError for blocked requests
- [ ] Supabase auth.onAuthStateChange listener updates UI on verification

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Middleware | apps/server | src/middleware/email-verification.middleware.ts |
| Errors | apps/server | src/errors/email-not-verified.error.ts |
| View | apps/web | src/app/(auth)/verify-email/page.tsx |
| Components | packages/ui | src/components/auth/verification-banner.tsx |
| Tests | apps/server | src/middleware/__tests__/email-verification.middleware.test.ts |

## Dependencies
- **Blocks:** none
- **Blocked by:** S-U-01-1, S-U-01-2, S-U-02-1
- **Cross-epic:** none

## Notes
- Supabase handles the verification email sending and callback; this story wraps the UX around it.
- Middleware order: AuthMiddleware -> EmailVerificationMiddleware -> RbacMiddleware.
- Exempt endpoints from verification check: POST /auth/resend-verification, GET /auth/verify-callback.
- Rate limiting on resend uses a simple in-memory counter per user ID (production: Redis).
