# STORY-U-9 Brief: Invitation Acceptance Flow

## 0. Lane & Priority

```yaml
story_id: STORY-U-9
old_id: S-U-02-2
lane: universal
lane_priority: 0
within_lane_order: 9
sprint: 3
size: M
depends_on:
  - STORY-U-1 (universal) — Supabase Auth Setup ✅ DONE
  - STORY-U-3 (universal) — Express Auth Middleware ✅ DONE
  - STORY-SA-5 (superadmin) — Approval Workflow (creates invitation record + token)
blocks:
  - STORY-U-13 — Persona Onboarding Screens
personas_served: [institutional_admin]
epic: E-02 (Registration & Onboarding)
feature: F-01 (Authentication & Access)
user_flow: UF-02 (Registration & Onboarding)
```

## 1. Summary

Build the **invitation acceptance flow** that allows an invited institutional admin to accept their platform invitation by validating a secure token and creating their account. The flow begins when the invited user clicks the branded link `/invite/accept?token=xxx` (generated by SA-5's approval workflow). The page validates the token (checking expiry, single-use, valid institution), displays a form to set their password (email pre-filled from invitation), creates a Supabase auth user with pre-assigned `institutional_admin` role, writes the user profile via DualWrite (Supabase + Neo4j), links the user to the inviting institution, marks the token as consumed, and redirects to persona onboarding (U-13).

This is the fourth step in the E-02 Registration & Onboarding pipeline: U-8 (registration) → SA-5 (approval sends invitation) → **U-9 (invitation acceptance)** → U-13 (onboarding).

Key constraints:
- Token validation: 7-day expiry (set by SA-5), single-use, must reference valid institution
- Role is fixed by the inviter — no role selection during acceptance
- DualWrite: Supabase profile first → Neo4j User node second
- Constructor DI for `InvitationAcceptanceService` receiving `AuthService` and `DualWriteService`
- Password must meet platform requirements (min 8 chars, upper, lower, number, special)

## 2. Task Breakdown

1. **Types** — Create `InvitationTokenPayload`, `InvitationAcceptRequest`, `InvitationAcceptResult` in `packages/types/src/auth/invitation.types.ts`
2. **Error classes** — `InvitationExpiredError`, `InvitationAlreadyUsedError`, `InvitationNotFoundError`, `InvitationInvalidError` in `apps/server/src/errors/invitation.error.ts`
3. **Service** — `InvitationAcceptanceService` with `validateToken()` and `acceptInvitation()` methods
4. **Controller** — `InvitationAcceptanceController` with `handleValidate()` and `handleAccept()` methods
5. **Routes** — Public routes `GET /api/v1/invitations/validate?token=xxx` and `POST /api/v1/invitations/accept`
6. **Frontend page** — `/invite/accept` page with token validation and password form
7. **Frontend components** — `InvitationAcceptForm` (organism)
8. **Wire up** — Register routes in `apps/server/src/index.ts` (public, no auth required)
9. **API tests** — 10 tests covering token validation, acceptance, errors, dual-write

## 3. Data Model (inline, complete)

```typescript
// packages/types/src/auth/invitation.types.ts

/** Shape of an invitation record from the database */
export interface InvitationRecord {
  readonly id: string;
  readonly token: string;
  readonly email: string;
  readonly role: string;
  readonly institution_id: string;
  readonly created_by: string;
  readonly expires_at: string;
  readonly accepted_at: string | null;
  readonly created_at: string;
}

/** Result of token validation (returned to frontend for display) */
export interface InvitationTokenPayload {
  readonly invitation_id: string;
  readonly email: string;
  readonly role: string;
  readonly institution_id: string;
  readonly institution_name: string;
  readonly expires_at: string;
  readonly is_valid: boolean;
}

/** Request body for accepting an invitation */
export interface InvitationAcceptRequest {
  readonly token: string;
  readonly password: string;
  readonly full_name: string;
}

/** Result returned after successful acceptance */
export interface InvitationAcceptResult {
  readonly user_id: string;
  readonly email: string;
  readonly role: string;
  readonly institution_id: string;
  readonly institution_name: string;
  readonly accepted_at: string;
}
```

## 4. Database Schema (inline, complete)

No new tables needed. Uses existing `invitations` table (created in SA-5) and `profiles` table.

```sql
-- Existing tables used:

-- invitations (created in SA-5 migration)
-- invitations.id UUID PK
-- invitations.token TEXT UNIQUE NOT NULL
-- invitations.email TEXT NOT NULL
-- invitations.role TEXT NOT NULL CHECK ('institutional_admin'|'faculty'|'student'|'advisor')
-- invitations.institution_id UUID FK -> institutions(id)
-- invitations.created_by UUID FK -> profiles(id)
-- invitations.expires_at TIMESTAMPTZ NOT NULL
-- invitations.accepted_at TIMESTAMPTZ (null until accepted)
-- invitations.created_at TIMESTAMPTZ DEFAULT NOW()

-- profiles (update on acceptance)
-- profiles.id UUID PK (= Supabase auth.users.id)
-- profiles.email TEXT NOT NULL
-- profiles.full_name TEXT
-- profiles.role TEXT NOT NULL
-- profiles.institution_id UUID FK -> institutions(id)
-- profiles.onboarding_completed BOOLEAN DEFAULT false
-- profiles.created_at TIMESTAMPTZ
-- profiles.updated_at TIMESTAMPTZ

-- institutions (lookup for display)
-- institutions.id UUID PK
-- institutions.name TEXT
-- institutions.status TEXT CHECK ('approved'|'suspended')
```

## 5. API Contract (complete request/response)

### GET /api/v1/invitations/validate?token=xxx (Public — no auth)

**Query Parameters:**
| Param | Type | Description |
|-------|------|-------------|
| `token` | string | The 48-char invitation token from the URL |

**Success Response (200):**
```json
{
  "data": {
    "invitation_id": "inv-uuid-1",
    "email": "jsmith@msm.edu",
    "role": "institutional_admin",
    "institution_id": "inst-uuid-1",
    "institution_name": "Morehouse School of Medicine",
    "expires_at": "2026-02-26T12:00:00Z",
    "is_valid": true
  },
  "error": null
}
```

**Error Responses:**

| Status | Code | When |
|--------|------|------|
| 400 | `VALIDATION_ERROR` | Missing token parameter |
| 404 | `INVITATION_NOT_FOUND` | Token does not match any invitation |
| 410 | `INVITATION_EXPIRED` | Token has passed its `expires_at` date |
| 410 | `INVITATION_ALREADY_USED` | Token's `accepted_at` is not null |
| 500 | `INTERNAL_ERROR` | Unexpected server error |

### POST /api/v1/invitations/accept (Public — no auth)

**Request Body:**
```json
{
  "token": "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4",
  "password": "SecureP@ss1",
  "full_name": "Dr. Jane Smith"
}
```

**Success Response (200):**
```json
{
  "data": {
    "user_id": "user-uuid-1",
    "email": "jsmith@msm.edu",
    "role": "institutional_admin",
    "institution_id": "inst-uuid-1",
    "institution_name": "Morehouse School of Medicine",
    "accepted_at": "2026-02-19T14:00:00Z"
  },
  "error": null
}
```

**Error Responses:**

| Status | Code | When |
|--------|------|------|
| 400 | `VALIDATION_ERROR` | Missing token, password, or full_name; password too weak |
| 404 | `INVITATION_NOT_FOUND` | Token does not match any invitation |
| 410 | `INVITATION_EXPIRED` | Token has passed its `expires_at` date |
| 410 | `INVITATION_ALREADY_USED` | Token's `accepted_at` is not null |
| 409 | `USER_ALREADY_EXISTS` | Email already registered in Supabase auth |
| 500 | `INTERNAL_ERROR` | Unexpected server error |

## 6. Frontend Spec

### Page: `/invite/accept` (Auth layout — public)

**Route:** `apps/web/src/app/(auth)/invite/accept/page.tsx`

**Component hierarchy:**
```
InviteAcceptPage (page.tsx — default export)
  └── InvitationAcceptFlow (client component)
        ├── TokenValidating (loading state while validating token from URL)
        ├── TokenInvalid (error states: expired, used, not found)
        │     ├── Error message
        │     └── "Request New Invitation" link
        └── InvitationAcceptForm (organism — shown when token is valid)
              ├── InstitutionBanner (institution name + role being assigned)
              ├── EmailDisplay (pre-filled, read-only from invitation)
              ├── FullNameInput (text input)
              ├── PasswordInput (with strength indicator from U-11)
              ├── ConfirmPasswordInput
              └── AcceptButton ("Create Account & Join")
```

**States:**
1. **Validating** — Spinner while GET /validate runs on page load
2. **Invalid** — Error message for expired, used, or not found tokens
3. **Form** — Token valid, acceptance form displayed
4. **Submitting** — Form disabled, spinner on button
5. **Success** — Redirect to `/onboarding` (U-13)
6. **Error** — Inline error message with retry

**Design tokens:**
- Surface: White card on Cream `#f5f3ef` background
- Institution banner: Navy Deep `#002c76` text on Parchment `#faf9f6`
- Accept button: Green `#69a338` background
- Typography: Lora for heading "Join [Institution Name]", Source Sans 3 for form
- Spacing: 24px form gap, 16px input gap

## 7. Files to Create (exact paths, implementation order)

| # | File | Layer | Action |
|---|------|-------|--------|
| 1 | `packages/types/src/auth/invitation.types.ts` | Types | Create |
| 2 | `packages/types/src/auth/index.ts` | Types | Edit (add invitation export) |
| 3 | `apps/server/src/errors/invitation.error.ts` | Errors | Create |
| 4 | `apps/server/src/errors/index.ts` | Errors | Edit (add invitation exports) |
| 5 | `apps/server/src/services/auth/invitation-acceptance.service.ts` | Service | Create |
| 6 | `apps/server/src/controllers/auth/invitation-acceptance.controller.ts` | Controller | Create |
| 7 | `apps/server/src/index.ts` | Routes | Edit (add public invitation routes) |
| 8 | `apps/web/src/app/(auth)/invite/accept/page.tsx` | View | Create |
| 9 | `apps/web/src/components/auth/invitation-accept-form.tsx` | Component | Create |
| 10 | `apps/server/src/services/auth/__tests__/invitation-acceptance.service.test.ts` | Tests | Create |
| 11 | `apps/server/src/controllers/auth/__tests__/invitation-acceptance.controller.test.ts` | Tests | Create |

## 8. Dependencies

### Story Dependencies
| Story | Lane | Status | Why |
|-------|------|--------|-----|
| STORY-U-1 | universal | **DONE** | Supabase Auth — user creation via `supabase.auth.admin.createUser()` |
| STORY-U-3 | universal | **DONE** | Express Auth Middleware — AuthService for user creation |
| STORY-SA-5 | superadmin | **PENDING** | Creates `invitations` table and invitation records with tokens |

### NPM Packages (already installed)
- `@supabase/supabase-js` — Supabase client (auth + DB)
- `express` — Server framework
- `vitest` — Testing

### Existing Files Needed
- `apps/server/src/config/supabase.config.ts` — `getSupabaseClient()`
- `apps/server/src/services/auth/auth.service.ts` — `AuthService` for user creation
- `apps/server/src/errors/base.errors.ts` — `JourneyOSError`
- `packages/types/src/auth/auth.types.ts` — `ApiResponse<T>`
- `apps/web/src/components/auth/password-strength-indicator.tsx` — Reuse from U-11
- `apps/web/src/lib/validation/password.ts` — `validatePassword()` from U-11

### Neo4j (optional for Sprint 3)
- DualWrite creates `(:User {id, email, role})-[:BELONGS_TO]->(:Institution)` in Neo4j
- If driver not available, skip graph write and log warning

## 9. Test Fixtures (inline)

```typescript
// Mock valid invitation (not expired, not used)
export const MOCK_VALID_INVITATION = {
  id: "inv-1",
  token: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4",
  email: "jsmith@msm.edu",
  role: "institutional_admin",
  institution_id: "inst-1",
  created_by: "sa-uuid-1",
  expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString(),
  accepted_at: null,
  created_at: "2026-02-19T12:00:00Z",
};

// Mock expired invitation
export const MOCK_EXPIRED_INVITATION = {
  ...MOCK_VALID_INVITATION,
  id: "inv-2",
  token: "expired-token-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  expires_at: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
};

// Mock already-used invitation
export const MOCK_USED_INVITATION = {
  ...MOCK_VALID_INVITATION,
  id: "inv-3",
  token: "used-token-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx",
  accepted_at: "2026-02-18T10:00:00Z",
};

// Mock institution for display
export const MOCK_INSTITUTION = {
  id: "inst-1",
  name: "Morehouse School of Medicine",
  domain: "msm.edu",
  status: "approved",
};

// Valid acceptance request
export const VALID_ACCEPT_REQUEST = {
  token: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4",
  password: "SecureP@ss1",
  full_name: "Dr. Jane Smith",
};

// Invalid: weak password
export const WEAK_PASSWORD_REQUEST = {
  token: "a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4",
  password: "weak",
  full_name: "Dr. Jane Smith",
};

// Mock created user (returned by Supabase auth)
export const MOCK_CREATED_USER = {
  id: "user-uuid-1",
  email: "jsmith@msm.edu",
  app_metadata: { role: "institutional_admin" },
};
```

## 10. API Test Spec (vitest -- PRIMARY)

**File:** `apps/server/src/services/auth/__tests__/invitation-acceptance.service.test.ts`

```
describe("InvitationAcceptanceService")
  describe("validateToken")
    ✓ returns valid payload for unexpired, unused token
    ✓ throws InvitationNotFoundError for unknown token
    ✓ throws InvitationExpiredError for expired token
    ✓ throws InvitationAlreadyUsedError for consumed token
    ✓ includes institution_name in payload

  describe("acceptInvitation")
    ✓ creates Supabase auth user with email and role
    ✓ creates profile in profiles table with institution_id
    ✓ marks invitation as consumed (sets accepted_at)
    ✓ returns accept result with user_id, email, role, institution_id
    ✓ throws on weak password (validation)
    ✓ throws UserAlreadyExistsError when email already registered
    ✓ re-validates token before accepting (expired check)
```

**File:** `apps/server/src/controllers/auth/__tests__/invitation-acceptance.controller.test.ts`

```
describe("InvitationAcceptanceController")
  describe("handleValidate")
    ✓ returns 200 with valid token payload
    ✓ returns 400 when token query param missing
    ✓ returns 404 for unknown token
    ✓ returns 410 for expired token
    ✓ returns 410 for already-used token

  describe("handleAccept")
    ✓ returns 200 with accept result for valid request
    ✓ returns 400 for missing fields (token, password, full_name)
    ✓ returns 400 for weak password
    ✓ returns 409 for already-registered email
```

**Total: ~21 tests** (12 service + 9 controller)

## 11. E2E Test Spec (Playwright -- CONDITIONAL)

Not required for this individual story. E2E coverage will be added when the full onboarding pipeline (SA-5 → U-9 → U-13) is complete as part of the "Institution Onboarding" critical journey.

## 12. Acceptance Criteria

1. Invitation URL `/invite/accept?token=xxx` loads and validates the token on page mount
2. Valid token shows acceptance form with pre-filled email and institution name
3. Expired token shows clear error with "Request New Invitation" link
4. Already-used token redirects to login page with message
5. Acceptance form: full name, set password, confirm password (email read-only)
6. Password validation enforces min 8 chars, upper, lower, number, special
7. `InvitationAcceptanceService` validates token, creates Supabase user with pre-assigned role
8. User profile created in `profiles` table with `institution_id` and `role` from invitation
9. Token marked as consumed (`accepted_at` set) after successful acceptance
10. Redirect to `/onboarding` (U-13) after account creation
11. Role is fixed by the inviter — no role selection during acceptance
12. All ~21 API tests pass

## 13. Source References

| Claim | Source |
|-------|--------|
| Invitation acceptance flow | S-U-02-2 § User Story |
| Token validation (expiry, single-use) | S-U-02-2 § Acceptance Criteria |
| Pre-assigned role from invitation | S-U-02-2 § Notes: "role is fixed by the inviter" |
| DualWrite for user profile | S-U-02-2 § Acceptance Criteria: "DualWriteService creates user profile" |
| Institution linking | S-U-02-2 § Acceptance Criteria: "User automatically associated with inviting institution" |
| Invitation table schema | STORY-SA-5 Brief § Database Schema |
| Token format (48-char crypto) | STORY-SA-5 Brief § Implementation Notes |
| Redirect to onboarding | S-U-02-2 § Acceptance Criteria: "Redirect to persona onboarding" |

## 14. Environment Prerequisites

- **Supabase:** Project `hifqdotmnirepgscankl` running, `invitations` table exists (from SA-5), `profiles` and `institutions` tables exist
- **Express:** Server running on port 3001
- **Next.js:** Web app running on port 3000
- **Neo4j:** Optional for Sprint 3. DualWrite stubs if unavailable.

## 15. Implementation Notes

- **Public routes:** Token validation and acceptance are PUBLIC endpoints (no auth middleware). The user does not have an account yet.
- **Constructor DI:** `InvitationAcceptanceService` receives `supabaseClient` via constructor. Use `supabase.auth.admin.createUser()` for server-side user creation with pre-confirmed email.
- **Token lookup:** Query `invitations` by `token` column. Check `expires_at > NOW()` and `accepted_at IS NULL`.
- **Institution join:** Set `profiles.institution_id` to the invitation's `institution_id` during profile creation.
- **Password reuse:** Reuse `validatePassword()` from `apps/web/src/lib/validation/password.ts` — extract to shared `packages/types` or duplicate server-side.
- **Redirect:** After successful acceptance, return the accept result. Frontend handles redirect to `/onboarding`.
- **Express params:** Token comes from query string (`req.query.token`) for validate, request body for accept. Both are `string | string[]` — narrow with `typeof === "string"`.
- **Supabase user creation:** Use `supabase.auth.admin.createUser({ email, password, email_confirm: true, app_metadata: { role } })` to create pre-confirmed user.
