# S-IA-28-4: Nightly Coverage Job

**Epic:** E-28 (Coverage Computation & Heatmap)
**Feature:** F-13
**Sprint:** 8
**Lane:** institutional_admin (P2)
**Size:** S

## User Story
As an **Institutional Admin**, I need coverage data to be automatically recalculated nightly so that the heatmap and gap analysis always reflect the latest question bank state without manual intervention.

## Acceptance Criteria
- [ ] Inngest function `coverage/nightly-recompute` scheduled via cron at 2:00 AM UTC
- [ ] Iterates over all active institutions, computes fresh coverage snapshot for each
- [ ] Compares new snapshot to previous: identifies new gaps and resolved gaps
- [ ] Emits `coverage.gaps.detected` event if new gaps found (consumed by S-IA-29-3 alert service)
- [ ] Stores new snapshot in Supabase `coverage_snapshots` table
- [ ] Job telemetry: duration, institutions processed, errors logged
- [ ] Retry logic: 3 retries with exponential backoff on transient Neo4j failures
- [ ] 5-8 API tests: scheduled execution, snapshot creation, gap detection, retry on failure, event emission
- [ ] Named exports only, TypeScript strict

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/coverage/jobs.types.ts` |
| Service | apps/server | `src/services/coverage/nightly-coverage.job.ts` |
| Config | apps/server | `src/config/inngest.config.ts` (update) |
| Tests | apps/server | `src/tests/coverage/nightly-coverage.job.test.ts` |

## Dependencies
- **Blocks:** S-IA-29-3
- **Blocked by:** S-IA-28-1 (coverage computation service)
- **Cross-epic:** none

## Notes
- Inngest cron syntax: `"0 2 * * *"` for daily at 2 AM UTC
- Job reuses `CoverageComputationService.computeForInstitution(institutionId)` from S-IA-28-1
- Gap detection: compare `previous_snapshot.matrix[system][discipline].gap_count` vs `new_snapshot.matrix[system][discipline].gap_count`
- Event payload for `coverage.gaps.detected`: `{ institution_id, new_gaps: [{system, discipline, gap_count}], timestamp }`
- Keep last 30 snapshots per institution for trend analysis; prune older ones
- Monitor via Inngest dashboard for job health
