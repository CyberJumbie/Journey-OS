# S-IA-06-1: User List & Invitation

**Epic:** E-06 (Per-Institution User Management)
**Feature:** F-03
**Sprint:** 3
**Lane:** institutional_admin (P2)
**Size:** L

## User Story
As an **Institutional Admin**, I need to view all users in my institution and invite new faculty/students/advisors so that I can manage my institution's team on the platform.

## Acceptance Criteria
- [ ] User list page at /institution/users (Institutional Admin only)
- [ ] Table columns: name, email, role, status (active/pending/deactivated), last login
- [ ] Sortable by: name, role, status, last login
- [ ] Filterable by: role, status
- [ ] Search by name or email
- [ ] Pagination: 25 items per page with cursor-based navigation
- [ ] Invite button opens modal with: email, role selection (faculty, student, advisor)
- [ ] InvitationService creates invitation record and dispatches email
- [ ] Invited users appear in list with status='pending' until they accept
- [ ] Institution scoping: only users from req.user.institution_id visible
- [ ] DualWriteService for invitation records
- [ ] 15 API tests: list, pagination, filtering, sorting, search, invite creation, duplicate invite, role validation, institution scoping, auth enforcement, email dispatch mock, status tracking, invalid email, cursor navigation, empty results
- [ ] 1 E2E test: invite flow end-to-end

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | src/user/user-management.types.ts |
| Model | apps/server | src/models/institution-user.model.ts |
| Repository | apps/server | src/repositories/institution-user.repository.ts |
| Service | apps/server | src/services/user/institution-user.service.ts, src/services/email/user-invitation-email.service.ts |
| Controller | apps/server | src/controllers/user/institution-user.controller.ts |
| Routes | apps/server | src/routes/institution/user-management.routes.ts |
| View | apps/web | src/app/(protected)/institution/users/page.tsx |
| Components | packages/ui | src/components/tables/user-table.tsx, src/components/modals/invite-user-modal.tsx |
| Tests | apps/server | src/controllers/user/__tests__/institution-user.controller.test.ts, src/services/user/__tests__/institution-user.service.test.ts |
| E2E | apps/web | e2e/user-invitation.spec.ts |

## Dependencies
- **Blocks:** S-IA-06-2, S-IA-06-3
- **Blocked by:** S-U-01-3, S-SA-04-3 (institution must exist first)
- **Cross-epic:** S-U-02-2 (invited users accept via invitation flow)

## Notes
- Institution scoping is critical: middleware must enforce `WHERE institution_id = req.user.institution_id`.
- User table organism should be reusable; similar pattern used in S-SA-07-1 global directory.
- Invitation reuses the same email service pattern from S-SA-04-3 but with different role options.
- DualWriteService: Supabase invitation first -> Neo4j INVITED_TO relationship second.
