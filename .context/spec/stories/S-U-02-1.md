# S-U-02-1: Registration Wizard

**Epic:** E-02 (Registration & Onboarding)
**Feature:** F-01
**Sprint:** 3
**Lane:** universal (P0)
**Size:** L

## User Story
As a **new user**, I need a multi-step registration wizard that captures my role, profile information, institution, and FERPA consent so that I can create a fully configured account in one flow.

## Acceptance Criteria
- [ ] 4-step wizard: Role Selection -> Profile Info -> Institution Association -> FERPA Consent
- [ ] Step 1: Role selection from available personas (faculty, student, advisor)
- [ ] Step 2: Name, email, password with validation (8+ chars, uppercase, number)
- [ ] Step 3: Institution search/select or request new institution
- [ ] Step 4: FERPA consent checkbox with full disclosure text, timestamp recorded
- [ ] Form state persisted across steps (no data loss on back navigation)
- [ ] Server-side validation on submission via registration controller
- [ ] RegistrationService creates Supabase auth user + profile record
- [ ] DualWriteService: Supabase user profile first, Neo4j Person node second
- [ ] Registration triggers email verification (S-U-02-4)
- [ ] Error handling: duplicate email, invalid institution, network failures
- [ ] Responsive design using design tokens from packages/ui
- [ ] 15 API tests: validation per step, duplicate email, successful registration, FERPA consent tracking, dual-write verification, institution association, role assignment
- [ ] 1 E2E test: complete registration flow end-to-end

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | src/auth/registration.types.ts |
| Model | apps/server | src/models/user-profile.model.ts |
| Repository | apps/server | src/repositories/user-profile.repository.ts |
| Service | apps/server | src/services/auth/registration.service.ts |
| Controller | apps/server | src/controllers/auth/registration.controller.ts |
| Routes | apps/server | src/routes/auth.routes.ts |
| View | apps/web | src/app/(auth)/register/page.tsx, src/app/(auth)/register/steps/role-step.tsx, src/app/(auth)/register/steps/profile-step.tsx, src/app/(auth)/register/steps/institution-step.tsx, src/app/(auth)/register/steps/consent-step.tsx |
| Components | packages/ui | src/components/forms/wizard-stepper.tsx, src/components/forms/password-input.tsx |
| Tests | apps/server | src/controllers/auth/__tests__/registration.controller.test.ts, src/services/auth/__tests__/registration.service.test.ts |
| E2E | apps/web | e2e/registration.spec.ts |

## Dependencies
- **Blocks:** S-U-02-3
- **Blocked by:** S-U-01-1, S-U-01-2
- **Cross-epic:** S-U-02-4 (email verification triggered after registration)

## Notes
- DualWriteService pattern: Supabase first -> Neo4j second -> sync_status = 'synced'.
- Wizard state managed with React context or URL params, not global store.
- FERPA consent must record: version, timestamp, IP address for compliance audit.
- Institution association: if institution not found, surface waitlist option (links to E-04).
- SuperAdmin and Institutional Admin cannot self-register; they are invited (S-U-02-2).
