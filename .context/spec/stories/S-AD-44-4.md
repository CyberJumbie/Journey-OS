# S-AD-44-4: Risk Flag Generation

**Epic:** E-44 (Risk Prediction Engine)
**Feature:** F-21
**Sprint:** 37
**Lane:** advisor (P5)
**Size:** M

## User Story
As a **system**, I need to run scheduled risk predictions and generate alert flags for at-risk students so that advisors are notified proactively.

## Acceptance Criteria
- [ ] Scheduled prediction job via Inngest: runs daily at 2:00 AM UTC
- [ ] Batch predict risk for all active students in each institution
- [ ] Generate risk flags for students classified as 'high' or 'critical'
- [ ] Flag record: student_id, risk_level, confidence, top_3_root_causes, created_at
- [ ] Flag deduplication: don't create duplicate flag if existing unresolved flag exists
- [ ] Flag escalation: upgrade flag severity if risk level increased since last flag
- [ ] Store flags in Supabase `risk_flags` table with dual-write to Neo4j
- [ ] Neo4j: (Student)-[:HAS_RISK_FLAG]->(RiskFlag) with properties
- [ ] Emit event for notification system (stub for E-34)
- [ ] API endpoint: GET /api/risk/flags (list), PATCH /api/risk/flags/:id (acknowledge)
- [ ] Dashboard count: number of new/unacknowledged flags per advisor

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/python-api | `src/models/risk_flag_types.py` |
| Model | packages/python-api | `src/models/risk_flag.py` |
| Repository | packages/python-api | `src/repositories/risk_flag_repository.py` |
| Service | packages/python-api | `src/services/risk_flag_service.py` |
| Job | packages/python-api | `src/jobs/risk_prediction_job.py` |
| Route | packages/python-api | `src/routes/risk_flags.py` |
| Tests | packages/python-api | `tests/test_risk_flag_service.py` |
| Tests | packages/python-api | `tests/test_risk_prediction_job.py` |

## Dependencies
- **Blocks:** S-AD-45-1 (advisor dashboard needs flags)
- **Blocked by:** S-AD-44-1 (GNN model for predictions), S-AD-44-2 (trajectory data), S-AD-44-3 (root causes)
- **Cross-epic:** Notification event connects to E-34

## Notes
- Inngest scheduled function: `inngest.create_function(fn_id="risk-prediction-daily", trigger=inngest.TriggerCron(cron="0 2 * * *"))`.
- DualWriteService pattern: Supabase `risk_flags` first, then Neo4j RiskFlag node.
- Flag lifecycle: created -> acknowledged -> resolved (with outcome tracking).
- Consider rate limiting flag generation to prevent advisor alert fatigue.
