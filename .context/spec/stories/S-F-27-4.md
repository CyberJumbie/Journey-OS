# S-F-27-4: Exam Lifecycle Management

**Epic:** E-27 (Exam Assignment & Export)
**Feature:** F-12
**Sprint:** 30
**Lane:** faculty (P3)
**Size:** M

## User Story
As a **faculty member**, I need to manage exam status transitions with an audit trail so that I can track the full lifecycle of each exam from creation to archival.

## Acceptance Criteria
- [ ] Status machine: draft -> assigned -> active -> completed -> archived
- [ ] Valid transitions enforced (e.g., cannot go from draft to completed)
- [ ] Each transition records: user, timestamp, previous status, new status, reason
- [ ] Audit trail viewable per exam (timeline view)
- [ ] Auto-transition: assigned -> active at scheduled start time (Inngest cron)
- [ ] Auto-transition: active -> completed at scheduled end time
- [ ] Manual override: admin can force transition with reason
- [ ] Status badge displayed on exam cards and detail pages
- [ ] API endpoints: PATCH /api/exams/:id/status, GET /api/exams/:id/audit-trail
- [ ] Notification stub on status change (connects to E-34)

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/exam/lifecycle.types.ts` |
| Model | apps/server | `src/modules/exam/models/exam-status-machine.ts` |
| Repository | apps/server | `src/modules/exam/repositories/exam-audit.repository.ts` |
| Service | apps/server | `src/modules/exam/services/exam-lifecycle.service.ts` |
| Controller | apps/server | `src/modules/exam/controllers/exam-lifecycle.controller.ts` |
| Route | apps/server | `src/modules/exam/routes/exam-lifecycle.routes.ts` |
| Job | apps/server | `src/modules/exam/jobs/exam-status-transition.job.ts` |
| View | apps/web | `src/components/exam/exam-status-badge.tsx` |
| View | apps/web | `src/components/exam/audit-trail-timeline.tsx` |
| API Tests | apps/server | `src/modules/exam/__tests__/exam-lifecycle.service.test.ts` |
| API Tests | apps/server | `src/modules/exam/__tests__/exam-status-machine.test.ts` |

## Dependencies
- **Blocks:** none
- **Blocked by:** S-F-27-1 (assignment creates initial lifecycle entry)
- **Cross-epic:** Auto-transitions use Inngest scheduled jobs

## Notes
- State machine pattern: explicit transition map with guards for valid transitions.
- Inngest cron job checks for exams needing status transitions every minute.
- Audit trail stored in Supabase `exam_audit_log` table (append-only).
- Status badge is a reusable atom component in packages/ui.
