# S-IA-28-3: Concept Graph Visualization

**Epic:** E-28 (Coverage Computation & Heatmap)
**Feature:** F-13
**Sprint:** 8
**Lane:** institutional_admin (P2)
**Size:** L

## User Story
As an **Institutional Admin**, I need a force-directed concept graph visualization color-coded by coverage so that I can explore the knowledge structure and identify clusters of under-assessed concepts.

## Acceptance Criteria
- [ ] D3 force-directed graph rendering SubConcept nodes and their relationships
- [ ] Nodes color-coded by coverage: red (unassessed), yellow (partially), green (fully assessed)
- [ ] Node size proportional to centrality score (PageRank)
- [ ] Edge rendering: `PART_OF`, `RELATED_TO`, `PREREQUISITE_OF` with distinct styles (solid, dashed, dotted)
- [ ] Zoom and pan controls with smooth transitions
- [ ] Node click: shows detail panel with concept name, coverage stats, linked SLOs, linked questions count
- [ ] Cluster detection: visually group concepts by USMLE System using force containment
- [ ] Search: find and focus on a specific concept by name
- [ ] Filter by USMLE System or Discipline to reduce graph complexity
- [ ] Performance: handle up to 500 nodes without frame drops (use canvas renderer for large graphs)
- [ ] 12-15 API tests: rendering, color mapping, interactions, search, filter, performance threshold
- [ ] Named exports only, TypeScript strict, design tokens only

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/coverage/concept-graph.types.ts` |
| Atoms | packages/ui | `src/atoms/graph-node.tsx`, `src/atoms/graph-edge.tsx` |
| Molecules | packages/ui | `src/molecules/graph-controls.tsx`, `src/molecules/concept-detail-panel.tsx` |
| Organisms | apps/web | `src/components/coverage/concept-graph.tsx` |
| Hooks | apps/web | `src/hooks/use-concept-graph-data.ts`, `src/hooks/use-graph-simulation.ts` |
| Utils | apps/web | `src/utils/graph-layout.ts` |
| Tests | apps/web | `src/tests/coverage/concept-graph.test.tsx`, `src/tests/coverage/graph-layout.test.ts` |

## Dependencies
- **Blocks:** none
- **Blocked by:** S-IA-28-1 (coverage data), S-IA-28-5 (centrality metrics for node sizing)
- **Cross-epic:** none

## Notes
- Use D3 force simulation (`d3.forceSimulation`) with React wrapper, not react-force-graph (too heavy)
- For >200 nodes, switch from SVG to Canvas renderer for performance
- Force parameters: charge strength -30, link distance 60, collision radius based on node size
- Cluster containment: use `d3.forceX`/`d3.forceY` with group-specific targets for each USMLE System
- Node detail panel is a slide-over (not a modal) to keep the graph visible
- Graph data fetched from `/api/coverage/concept-graph?system=X&discipline=Y`
- Neo4j query returns nodes + edges in a single call: `MATCH (sc:SubConcept)-[r]-() RETURN sc, r`
