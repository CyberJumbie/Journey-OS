# S-IA-06-2: Role Assignment & CD Flag

**Epic:** E-06 (Per-Institution User Management)
**Feature:** F-03
**Sprint:** 3
**Lane:** institutional_admin (P2)
**Size:** M

## User Story
As an **Institutional Admin**, I need to assign roles to users and toggle the Course Director flag for faculty members so that access permissions and course management capabilities are correctly configured.

## Acceptance Criteria
- [ ] Role dropdown on user detail/edit view: faculty, student, advisor
- [ ] Role change updates Supabase app_metadata.role and Neo4j Person node
- [ ] Course Director (CD) flag toggle visible only for faculty role users
- [ ] CD flag stored as boolean in user profile and Neo4j Person node
- [ ] CD flag grants additional permissions: course creation, SLO management
- [ ] Role change triggers DualWriteService update
- [ ] Confirmation dialog before role change (destructive action warning)
- [ ] Audit log entry for every role change: who, when, from_role, to_role
- [ ] 10 API tests: role update, CD flag toggle, non-faculty CD rejection, dual-write verification, auth enforcement, institution scoping, audit log creation, invalid role, concurrent update handling, permission matrix update

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | src/user/role-assignment.types.ts |
| Service | apps/server | src/services/user/role-assignment.service.ts |
| Controller | apps/server | src/controllers/user/role-assignment.controller.ts |
| View | apps/web | src/app/(protected)/institution/users/[id]/page.tsx |
| Components | packages/ui | src/components/forms/role-select.tsx, src/components/forms/cd-flag-toggle.tsx |
| Tests | apps/server | src/services/user/__tests__/role-assignment.service.test.ts, src/controllers/user/__tests__/role-assignment.controller.test.ts |

## Dependencies
- **Blocks:** none
- **Blocked by:** S-IA-06-1
- **Cross-epic:** none

## Notes
- CD flag is separate from role; a faculty member can be faculty without being a Course Director.
- Role changes must update JWT claims via Supabase admin API (app_metadata update).
- Audit logging is essential for compliance; store in a dedicated audit_logs table.
- DualWriteService: Supabase profile update first -> Neo4j Person node property update second.
