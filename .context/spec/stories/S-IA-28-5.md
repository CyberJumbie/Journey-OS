# S-IA-28-5: Centrality Metrics

**Epic:** E-28 (Coverage Computation & Heatmap)
**Feature:** F-13
**Sprint:** 8
**Lane:** institutional_admin (P2)
**Size:** M

## User Story
As an **Institutional Admin**, I need PageRank and betweenness centrality computed for concepts in the knowledge graph so that I can identify which concepts are most critical for curriculum coverage and prioritize gap remediation.

## Acceptance Criteria
- [ ] CentralityMetricsService computes PageRank for all SubConcept nodes in Neo4j
- [ ] CentralityMetricsService computes betweenness centrality for all SubConcept nodes
- [ ] Results stored per concept: `{ concept_id, pagerank, betweenness, computed_at }`
- [ ] Centrality data stored in Supabase `concept_metrics` table and as Neo4j node properties
- [ ] API endpoint `GET /api/coverage/centrality?system=X` returns ranked concepts
- [ ] High-centrality unassessed concepts flagged as "critical gaps"
- [ ] Computation triggered by nightly job (piggybacks on S-IA-28-4) or on-demand via API
- [ ] 8-10 API tests: PageRank computation, betweenness computation, storage, ranking, critical gap flagging
- [ ] Named exports only, TypeScript strict

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | `src/coverage/centrality.types.ts` |
| Model | apps/server | `src/models/concept-metrics.model.ts` |
| Repository | apps/server | `src/repositories/concept-metrics.repository.ts` |
| Service | apps/server | `src/services/coverage/centrality-metrics.service.ts` |
| Controller | apps/server | `src/controllers/coverage.controller.ts` (update) |
| Tests | apps/server | `src/tests/coverage/centrality-metrics.test.ts` |

## Dependencies
- **Blocks:** S-IA-28-3 (concept graph uses centrality for node sizing)
- **Blocked by:** S-IA-28-1 (coverage computation service must exist)
- **Cross-epic:** none

## Notes
- Use Neo4j Graph Data Science (GDS) library for PageRank and betweenness: `CALL gds.pageRank.stream(...)` and `CALL gds.betweenness.stream(...)`
- GDS requires a named graph projection: `CALL gds.graph.project('concept-graph', 'SubConcept', ['PART_OF', 'RELATED_TO', 'PREREQUISITE_OF'])`
- PageRank parameters: dampingFactor 0.85, maxIterations 20, tolerance 0.0001
- Critical gap threshold: concept with pagerank > 75th percentile AND coverage = 0
- DualWriteService pattern: write centrality to Supabase `concept_metrics` first, then update Neo4j node properties `sc.pagerank`, `sc.betweenness`
- Computation takes ~5-15s for 1000 concepts; run async, not blocking API response
