# S-U-02-2: Invitation Acceptance Flow

**Epic:** E-02 (Registration & Onboarding)
**Feature:** F-01
**Sprint:** 3
**Lane:** universal (P0)
**Size:** M

## User Story
As an **invited institutional admin**, I need to accept my invitation by validating the token and creating my account so that I can begin managing my institution on the platform.

## Acceptance Criteria
- [ ] Invitation URL contains secure token: /invite/accept?token=xxx
- [ ] Token validation: check expiry (72h), single-use, valid institution
- [ ] Expired token shows clear error with "request new invitation" link
- [ ] Already-used token redirects to login page with message
- [ ] Acceptance form: set password, confirm email (pre-filled from invitation)
- [ ] InvitationService validates token, creates Supabase user with pre-assigned role
- [ ] DualWriteService creates user profile in Supabase + Neo4j
- [ ] User automatically associated with inviting institution
- [ ] Token marked as consumed after successful acceptance
- [ ] Redirect to persona onboarding (S-U-02-3) after account creation
- [ ] 10 API tests: valid token, expired token, used token, invalid token, password validation, user creation, dual-write, institution linking, role assignment, edge cases

## Implementation Layers
| Layer | Package | Files |
|-------|---------|-------|
| Types | packages/types | src/auth/invitation.types.ts |
| Service | apps/server | src/services/auth/invitation.service.ts |
| Controller | apps/server | src/controllers/auth/invitation.controller.ts |
| Routes | apps/server | src/routes/invitation.routes.ts |
| View | apps/web | src/app/(auth)/invite/accept/page.tsx |
| Tests | apps/server | src/controllers/auth/__tests__/invitation.controller.test.ts, src/services/auth/__tests__/invitation.service.test.ts |

## Dependencies
- **Blocks:** S-U-02-3
- **Blocked by:** S-U-01-1, S-U-01-2, S-SA-04-3 (invitation sent during approval)
- **Cross-epic:** S-SA-04-3 (approval workflow dispatches the invitation email)

## Notes
- Token should be a signed JWT or opaque token stored in Supabase invitations table.
- Pre-assigned role comes from the invitation record (set by SuperAdmin during approval).
- Do not allow role changes during acceptance; role is fixed by the inviter.
- Constructor DI for InvitationService receiving AuthService and DualWriteService.
